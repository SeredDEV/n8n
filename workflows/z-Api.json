{
  "name": "z-Api",
  "nodes": [
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f1f4f21d-7bac-4148-8fa5-eb91e67e3f5e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "53ea1f96-c52a-4d1f-a00d-c0cafb1feb82"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b2b2b2b2-2222-3333-4444-555555555555"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "button_response",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c3c3c3c3-3333-4444-5555-666666666666"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "button"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3024,
        376
      ],
      "id": "21e27863-ba53-4dd7-a22d-fab641d638e9",
      "name": "Message Type Router"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "credentials-object",
              "name": "credentials",
              "value": "={{ { \"z_api_token\": $json.headers['z-api-token'], \"instance_id\": $json.body.instanceId } }}",
              "type": "object"
            },
            {
              "id": "system-object",
              "name": "system",
              "value": "={{ { \"execution_mode\": $json.executionMode, \"webhook_url\": $json.webhookUrl, \"user_agent\": $json.headers['user-agent'], \"origin_server\": $json.headers.origin, \"client_ip\": $json.headers['x-real-ip'] } }}",
              "type": "object"
            },
            {
              "id": "user-object",
              "name": "user",
              "value": "={{ { \"sender_phone\": $json.body.phone, \"connected_phone\": $json.body.connectedPhone, \"chat_name\": $json.body.chatName, \"sender_name\": $json.body.senderName, \"chat_lid\": $json.body.chatLid } }}",
              "type": "object"
            },
            {
              "id": "message-type-detector",
              "name": "message_type",
              "value": "={{ $json.body.text ? 'text' : $json.body.audio ? 'audio' : $json.body.image ? 'image' : $json.body.buttonsResponseMessage ? 'button_response' : $json.body.document ? ($json.body.document.mimeType && $json.body.document.mimeType.startsWith('audio/') ? 'audio_file' : $json.body.document.mimeType && $json.body.document.mimeType.startsWith('video/') ? 'video' : 'document') : 'unknown' }}",
              "type": "string"
            },
            {
              "id": "message-object",
              "name": "message",
              "value": "={{ { \"message_id\": $json.body.messageId, \"timestamp\": $json.body.momment, \"formatted_date\": DateTime.fromMillis($json.body.momment).toFormat('yyyy-MM-dd HH:mm:ss'), \"formatted_date_utc_minus_5\": DateTime.fromMillis($json.body.momment).setZone('UTC-5').toFormat('yyyy-MM-dd HH:mm:ss'), \"message_status\": $json.body.status, \"message_type\": ($json.body.text ? 'text' : $json.body.audio ? 'audio' : $json.body.image ? 'image' : $json.body.buttonsResponseMessage ? 'button_response' : $json.body.document ? ($json.body.document.mimeType && $json.body.document.mimeType.startsWith('audio/') ? 'audio_file' : $json.body.document.mimeType && $json.body.document.mimeType.startsWith('video/') ? 'video' : 'document') : 'unknown') } }}",
              "type": "object"
            },
            {
              "id": "content-text",
              "name": "text_content",
              "value": "={{ $json.body.text ? { \"message\": $json.body.text.message } : null }}",
              "type": "object"
            },
            {
              "id": "content-audio",
              "name": "audio_content",
              "value": "={{ $json.body.audio ? { \"audio_url\": $json.body.audio.audioUrl, \"duration_seconds\": $json.body.audio.seconds, \"mime_type\": $json.body.audio.mimeType, \"is_ptt\": $json.body.audio.ptt, \"view_once\": $json.body.audio.viewOnce, \"source\": 'audio_object' } : null }}",
              "type": "object"
            },
            {
              "id": "content-audio-file",
              "name": "audio_file_content",
              "value": "={{ ($json.body.document && $json.body.document.mimeType && $json.body.document.mimeType.startsWith('audio/')) ? { \"audio_url\": $json.body.document.documentUrl, \"file_name\": $json.body.document.fileName, \"mime_type\": $json.body.document.mimeType, \"caption\": $json.body.document.caption, \"title\": $json.body.document.title, \"source\": 'document_object' } : null }}",
              "type": "object"
            },
            {
              "id": "content-image",
              "name": "image_content",
              "value": "={{ $json.body.image ? { \"image_url\": $json.body.image.imageUrl, \"thumbnail_url\": $json.body.image.thumbnailUrl, \"caption\": $json.body.image.caption, \"mime_type\": $json.body.image.mimeType, \"view_once\": $json.body.image.viewOnce, \"width\": $json.body.image.width, \"height\": $json.body.image.height } : null }}",
              "type": "object"
            },
            {
              "id": "content-video",
              "name": "video_content",
              "value": "={{ ($json.body.document && $json.body.document.mimeType && $json.body.document.mimeType.startsWith('video/')) ? { \"video_url\": $json.body.document.documentUrl, \"file_name\": $json.body.document.fileName, \"mime_type\": $json.body.document.mimeType, \"caption\": $json.body.document.caption, \"title\": $json.body.document.title, \"source\": 'document_object' } : null }}",
              "type": "object"
            },
            {
              "id": "content-document",
              "name": "document_content",
              "value": "={{ ($json.body.document && (!$json.body.document.mimeType || (!$json.body.document.mimeType.startsWith('audio/') && !$json.body.document.mimeType.startsWith('video/')))) ? { \"document_url\": $json.body.document.documentUrl, \"file_name\": $json.body.document.fileName, \"title\": $json.body.document.title, \"caption\": $json.body.document.caption, \"mime_type\": $json.body.document.mimeType, \"page_count\": $json.body.document.pageCount } : null }}",
              "type": "object"
            },
            {
              "id": "content-button",
              "name": "button_content",
              "value": "={{ $json.body.buttonsResponseMessage ? { \"button_id\": $json.body.buttonsResponseMessage.buttonId, \"button_text\": $json.body.buttonsResponseMessage.message, \"button_response\": $json.body.buttonsResponseMessage.buttonId, \"display_text\": $json.body.buttonsResponseMessage.message } : null }}",
              "type": "object"
            },
            {
              "id": "flags-object",
              "name": "flags",
              "value": "={{ { \"from_me\": $json.body.fromMe, \"is_group\": $json.body.isGroup, \"is_newsletter\": $json.body.isNewsletter, \"is_forwarded\": $json.body.forwarded, \"is_broadcast\": $json.body.broadcast, \"callback_type\": $json.body.type, \"from_api\": $json.body.fromApi, \"is_status_reply\": $json.body.isStatusReply, \"is_edit\": $json.body.isEdit, \"waiting_message\": $json.body.waitingMessage, \"message_expiration_seconds\": $json.body.messageExpirationSeconds || 0 } }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3248,
        408
      ],
      "id": "629c91df-ca42-451f-81f0-e68a7117af0d",
      "name": "WhatsApp Message Parser"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "50a91089-2c34-4dd0-8896-2715bd6e9612",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3472,
        408
      ],
      "id": "852dc0cf-eee3-4b06-96d2-7434d5f2105c",
      "name": "Webhook",
      "webhookId": "50a91089-2c34-4dd0-8896-2715bd6e9612"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -2800,
        352
      ],
      "id": "dd409521-a6e3-458e-8735-fcd45edabb22",
      "name": "Pausa",
      "webhookId": "0bfa0972-a628-48bb-be5d-b3c30b33df0e"
    },
    {
      "parameters": {
        "url": "={{ $json.audio_content.audio_url }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2800,
        160
      ],
      "id": "8333ce84-4d86-45b2-82ad-918529eedb94",
      "name": "Download Audio File"
    },
    {
      "parameters": {
        "url": "={{ $json.image_content.image_url }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2800,
        544
      ],
      "id": "cf653602-6501-49dc-8e34-58663392a016",
      "name": "Download Image File"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "# Instrucciones para DescripciÃ³n de Imagen\nDescribe esta imagen en espaÃ±ol.",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2576,
        544
      ],
      "id": "4f8f60c9-6636-4187-9180-3ae5bae89d18",
      "name": "Analyze Image",
      "credentials": {
        "openAiApi": {
          "id": "4I5hY4XwoALE8VJS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "button-response-id",
              "name": "button_id",
              "value": "={{ $json.button_content.button_id }}",
              "type": "string"
            },
            {
              "id": "button-response-text",
              "name": "button_text",
              "value": "={{ $json.button_content.button_text || $json.button_content.display_text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2800,
        1224
      ],
      "id": "16d840a8-6820-4683-9b2c-a5935ab53845",
      "name": "Process Button Response"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "catalogo",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "catalog-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "catalogo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "ofertas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "offers-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ofertas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "comprar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "buy-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "comprar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "order-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pedido"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2576,
        1192
      ],
      "id": "71dcbf2e-618c-4a6c-824d-e96d9bfb0de3",
      "name": "Button Response Router"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2576,
        160
      ],
      "id": "3c1f4fe7-fb56-420d-906b-f5543cd49364",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "4I5hY4XwoALE8VJS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
              "name": "mensaje",
              "type": "string",
              "value": "={{ $json.text || $json.content || $json.button_text || $json.button_id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "69805333-82b0-4af7-b76a-550e1e5214d2",
      "name": "Extract Message Content",
      "type": "n8n-nodes-base.set",
      "position": [
        -2352,
        352
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d4b9efeb-9a68-43e3-bc4c-cd207510bddf",
              "name": "text",
              "value": "={{ $json.text_content.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2576,
        352
      ],
      "id": "058d9a01-82a5-40fe-beac-d2466ef750e9",
      "name": "Obtener Texto"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2128,
        352
      ],
      "id": "3576f13b-3c67-4594-826a-9f42febf8543",
      "name": "Store Message in Buffer",
      "credentials": {
        "redis": {
          "id": "HBZtjEwzw7Xu4Gm2",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -1904,
        352
      ],
      "id": "eab92e45-1f03-462f-b583-724fcd6acff6",
      "name": "Wait for Buffer",
      "webhookId": "05929f0b-cb6a-48f9-901e-bbefe359f336"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1680,
        352
      ],
      "id": "8bfdc3e1-53fa-424c-9efc-012fc7b2f6a7",
      "name": "Retrieve Messages from Buffer",
      "credentials": {
        "redis": {
          "id": "HBZtjEwzw7Xu4Gm2",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "87d5a006-5e35-4dbf-a3dc-e5420b918845",
              "leftValue": "={{ $json.propertyName.last() }}",
              "rightValue": "={{ $('Extract Message Content').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1456,
        352
      ],
      "id": "36f42d41-3bfc-4f31-b193-f5c73dc5e280",
      "name": "Check for Duplicate Message"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1232,
        168
      ],
      "id": "5351af1d-38df-42d5-b226-b3d971c6e45e",
      "name": "Clear Buffer Cache",
      "credentials": {
        "redis": {
          "id": "HBZtjEwzw7Xu4Gm2",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1232,
        360
      ],
      "id": "a8fd631b-2db6-481d-bc77-9465e0ff749d",
      "name": "Skip Duplicate Message"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f6459d32-0468-4e3c-8572-7b36e1fc2172",
              "name": "conversation_content",
              "value": "={{ $json.propertyName.join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1008,
        168
      ],
      "id": "3985d04b-ff21-43fb-acc3-1c73256b49ff",
      "name": "Format Final Output"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    '{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}' as session_id,\n    EXISTS (\n        SELECT 1 \n        FROM n8n_pro_conversation_states \n        WHERE session_id = '{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}'\n    ) as existe",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -784,
        168
      ],
      "id": "67723d13-15ed-4332-93a5-ba6abbc17bf3",
      "name": "Get session_id",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7500bd18-477a-4fbe-b21d-ea6bbcc0a5d5",
              "leftValue": "={{ $json.existe }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -560,
        168
      ],
      "id": "3b6e6010-6bcf-4038-9493-cddaa630b656",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Obtener hora UTC y ajustarla a UTC-5\nconst ahora = new Date();\nconst horaUTC = ahora.getUTCHours();\nconst horaUTC5 = (horaUTC + 24 - 5) % 24;\n\n// Determinar perÃ­odo del dÃ­a\nlet periodo = '';\n\nif (horaUTC5 >= 5 && horaUTC5 < 12) {\n  periodo = 'maÃ±ana';\n} else if (horaUTC5 >= 12 && horaUTC5 < 18) {\n  periodo = 'tarde';\n} else {\n  periodo = 'noche';\n}\n\n// Retornar perÃ­odo junto con datos necesarios\nreturn [\n  {\n    json: {\n      periodo: periodo,\n      hora: horaUTC5,\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2352,
        760
      ],
      "id": "00e47220-1f45-4ac3-8a47-81a5d64d7a9a",
      "name": "Dynamic Time Greeting"
    },
    {
      "parameters": {
        "jsCode": "const saludos = [\n`ðŸŒ¸ Â¡Hola! Gracias por escribir a *Ed PerfumerÃ­a*  \nEstamos encantados de ayudarte a encontrar la fragancia ideal.`,\n\n`ðŸ’¬ Â¡Bienvenido a *Ed PerfumerÃ­a*!  \nGracias por elegirnos para tu prÃ³xima compra de perfumes.`,\n\n`ðŸŽ‰ Â¡Hola! QuÃ© gusto tenerte en *Ed PerfumerÃ­a*  \nEstamos aquÃ­ para ayudarte a encontrar tu aroma perfecto.`,\n\n`ðŸŒŸ Â¡Gracias por comunicarte con *Ed PerfumerÃ­a*!  \nNos alegra poder atenderte ðŸ˜Š`,\n\n`ðŸš€ Â¡Hola y bienvenido a *Ed PerfumerÃ­a*!  \nEs un placer atenderte hoy âœ¨`,\n\n`ðŸ™Œ Â¡Hola! Gracias por escribir a *Ed PerfumerÃ­a*  \nEstamos encantados de atenderte. ðŸ’`,\n\n`ðŸ‘‹ Â¡Bienvenid@ a *Ed PerfumerÃ­a*!  \nNos alegra recibir tu mensaje. ðŸ’–`,\n\n`âœ¨ Â¡Hola! Gracias por contactar a *Ed PerfumerÃ­a*  \nNos alegra mucho tenerte por aquÃ­ ðŸ˜Š`,\n\n`ðŸŒŸ Â¡Gracias por comunicarte con *Ed PerfumerÃ­a*!  \nEstamos aquÃ­ para ayudarte a encontrar tu fragancia ideal. ðŸ§´âœ¨`,\n\n`ðŸŽ‰ Â¡Bienvenido a *Ed PerfumerÃ­a*!  \nGracias por escribirnos. Estamos listos para asesorarte.`\n];\n\n// Selecciona uno al azar\nconst saludoAleatorio = saludos[Math.floor(Math.random() * saludos.length)];\nreturn [\n  {\n    json: {\n      output: saludoAleatorio\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        -128
      ],
      "id": "7033e5d9-92c7-4bdd-b9a3-1d0d2ee83e2d",
      "name": "Dynamic Greeting"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.periodo }}",
                    "rightValue": "maÃ±ana",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "eb8f4c83-efd2-4595-b674-25dc1c0ad1b8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "maÃ±ana"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dcc3cd98-a426-4020-8af1-a851981f2055",
                    "leftValue": "={{ $json.periodo }}",
                    "rightValue": "tarde",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarde"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b515e6bc-c3a2-4471-b9ee-ff723e6ff6cc",
                    "leftValue": "={{ $json.periodo }}",
                    "rightValue": "noche",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "noche"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2128,
        744
      ],
      "id": "7141152b-9336-43f9-a034-f18849e987b0",
      "name": "Switch1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.output.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -112,
        -128
      ],
      "id": "bca08f9f-5200-4812-bd94-f001547f49fe",
      "name": "Send Dynamic Greeting"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}\",\n  \"message\": \"{{ (() => { const h = new Date(new Date().getTime() - 18000000).getHours(); return h >= 5 && h < 12 ? 'Â¡Buenos dÃ­as!' : h >= 12 && h < 18 ? 'Â¡Buenas tardes!' : 'Â¡Buenas noches!'; })() }} ðŸŒ¸\\n\\nÂ¿QuÃ© te gustarÃ­a hacer?\",\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"buttons\": [\n      {\n        \"id\": \"comprar\",\n        \"label\": \"ðŸ›’ Comprar\"\n      },\n      {\n        \"id\": \"catalogo\",\n        \"label\": \"ðŸ“‹ CatÃ¡logo\"\n      },\n      {\n        \"id\": \"ofertas\",\n        \"label\": \"ðŸ”¥ Ofertas\"\n      },\n      {\n        \"id\": \"pedido\",\n        \"label\": \"ðŸ“¦ Consultar Pedido\"\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        488,
        -128
      ],
      "id": "d66ffd6d-acea-49bb-8070-1a2d91d6aee2",
      "name": "Send Buttons"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1680,
        816
      ],
      "id": "a07e3554-61bf-4247-b345-485c71a000e8",
      "name": "Merge Audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-audio",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "audio",
              "value": "=data:{{ $('Merge Audio').item.binary.data.mimeType }};base64,{{ $('Merge Audio').item.binary.data.data }}"
            },
            {
              "name": "delayTyping",
              "value": "6"
            },
            {
              "name": "waveform",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1456,
        832
      ],
      "id": "f6350737-0a0d-40bf-ac78-919fd8a0fe40",
      "name": "Send Audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-document/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').first().json.user.sender_phone }}"
            },
            {
              "name": "document",
              "value": "https://drive.google.com/uc?export=download&id=1z1N-NqCHW2PrC1_HJS01MP6geTL6Jf_S"
            },
            {
              "name": "fileName",
              "value": "CatÃ¡logo Ed PerfumerÃ­a Hombre"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1232,
        832
      ],
      "id": "1ce81b28-40cf-40ec-9392-c8e31235b7fa",
      "name": "Send Catalog Man"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-document/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').first().json.user.sender_phone }}"
            },
            {
              "name": "document",
              "value": "https://drive.google.com/uc?export=download&id=1sf7vcqR6USGi-b496e7kCshxMNwI-4c4"
            },
            {
              "name": "fileName",
              "value": "CatÃ¡logo Ed PerfumerÃ­a Mujer"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1008,
        832
      ],
      "id": "bad2d0f8-eb89-4d76-89db-811c8d943dc4",
      "name": "Send Catalog Women"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1UND_G3K4tu_xmjsTOSyq3ypRVpzg95HH",
          "mode": "list",
          "cachedResultName": "Buenos Dias.ogg",
          "cachedResultUrl": "https://drive.google.com/file/d/1UND_G3K4tu_xmjsTOSyq3ypRVpzg95HH/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -1904,
        552
      ],
      "id": "6aa2a2a5-3c53-4845-ab53-2f014e20f872",
      "name": "Download Good Morning",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "lZPZd6pI3LpqZuri",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1oFABnmJkXuevND9TxwJP_zcM2VLsDPtb",
          "mode": "list",
          "cachedResultName": "Buenas Tardes.ogg",
          "cachedResultUrl": "https://drive.google.com/file/d/1oFABnmJkXuevND9TxwJP_zcM2VLsDPtb/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -1904,
        744
      ],
      "id": "4ce4c093-a1e9-4bb5-896f-4b6e8360a612",
      "name": "Download Good Afternoon",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "lZPZd6pI3LpqZuri",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "16PkBRIK-Iv-VKInmhW1nq5Qfjc0EKWn2",
          "mode": "list",
          "cachedResultName": "Buenas Noches.ogg",
          "cachedResultUrl": "https://drive.google.com/file/d/16PkBRIK-Iv-VKInmhW1nq5Qfjc0EKWn2/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -1904,
        936
      ],
      "id": "f6c5071b-9cfa-4dbb-9118-b61101f82ca4",
      "name": "Download  Good Night",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "lZPZd6pI3LpqZuri",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ofertas = [\n`ðŸŽ€ *Promociones especiales de Ed PerfumerÃ­a*\n\nðŸ’Ž **Ofertas disponibles:**\n1 unidad â†’ $60.000\n2 unidades â†’ $100.000  \n3 unidades â†’ $120.000\n6 unidades â†’ $210.000\n\nðŸ”¥ Â¡Fragancias increÃ­bles a precios Ãºnicos!`,\n\n`ðŸŽ *Ofertas Ed PerfumerÃ­a*\n\nâœ¨ **Precios especiales:**\n1 por $60.000\n2 por $100.000\n3 por $120.000\n6 por $210.000\n\nðŸ’« Â¡Aprovecha nuestros mejores precios!`,\n\n`ðŸ’Ž *PromociÃ³n de la semana*\n\nðŸ”¥ **Ofertas vigentes:**\n1 unidad: $60.000\n2 unidades: $100.000\n3 unidades: $120.000\n6 unidades: $210.000\n\nðŸŽ‰ Â¡No dejes pasar estas ofertas!`,\n\n`ðŸŒŸ *Ofertas especiales*\n\nðŸ’¥ **Promociones disponibles:**\n1 x $60.000 | 2 x $100.000 | 3 x $120.000 | 6 x $210.000\n\nâœ¨ Â¡Solo por tiempo limitado!`,\n\n`ðŸŽŠ *Ed PerfumerÃ­a - Ofertas*\n\nðŸŽ **Precios increÃ­bles:**\n1 fragancia â†’ $60.000\n2 fragancias â†’ $100.000\n3 fragancias â†’ $120.000\n6 fragancias â†’ $210.000\n\nðŸ”¥ Â¡Te van a encantar!`,\n\n`ðŸ’– *Promociones actuales*\n\nðŸŒ¸ **Ofertas de hoy:**\n1 unidad por $60.000\n2 unidades por $100.000\n3 unidades por $120.000\n6 unidades por $210.000\n\nðŸ’Ž Â¡Aprovecha esta oportunidad!`,\n\n`ðŸš€ *Ofertas Ed PerfumerÃ­a*\n\nâ­ **Precios especiales:**\n1 â†’ $60.000\n2 â†’ $100.000\n3 â†’ $120.000\n6 â†’ $210.000\n\nðŸŽ‰ Â¡Promociones por tiempo limitado!`,\n\n`ðŸŒˆ *PromociÃ³n especial*\n\nðŸ’« **Ofertas vigentes:**\n1 unidad: $60.000\n2 unidades: $100.000\n3 unidades: $120.000\n6 unidades: $210.000\n\nðŸ”¥ Â¡No te las pierdas!`,\n\n`ðŸŽ€ *Ofertas de la semana*\n\nâœ¨ **Precios Ãºnicos:**\n1 x $60.000 â€¢ 2 x $100.000 â€¢ 3 x $120.000 â€¢ 6 x $210.000\n\nðŸŽ Â¡Fragancias increÃ­bles a precios especiales!`,\n\n`ðŸ’ *Ed PerfumerÃ­a - Promociones*\n\nðŸŒŸ **Ofertas disponibles:**\n1 unidad = $60.000\n2 unidades = $100.000\n3 unidades = $120.000\n6 unidades = $210.000\n\nðŸ’Ž Â¡Aprovecha nuestras mejores ofertas!`\n];\n\n// Selecciona uno al azar\nconst ofertaAleatoria = ofertas[Math.floor(Math.random() * ofertas.length)];\nreturn [\n  {\n    json: {\n      output: ofertaAleatoria\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2352,
        1128
      ],
      "id": "711aeec0-e45c-4b1f-9c1a-e451f34dae88",
      "name": "Dynamic Offers"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.output.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2128,
        1128
      ],
      "id": "a7fbc787-90bb-4205-a8cb-c06bc288c642",
      "name": "Send Dynamic Offers"
    },
    {
      "parameters": {
        "jsCode": "const comprar = [\n`ðŸ›’ *Â¡Perfecto! Veamos quÃ© te interesa*\n\nÂ¿En quÃ© fragancia estÃ¡s pensando?\n- Â¿Tienes alguna en mente?\n- Â¿Buscas algo especÃ­fico?\n\nðŸ’Ž Â¡CuÃ©ntanos para ayudarte mejor!`,\n\n`ðŸ›ï¸ *Â¡Excelente!*\n\nÂ¿QuÃ© tipo de fragancia te llama la atenciÃ³n?\n- Â¿Algo dulce o fresco?\n- Â¿Para hombre o mujer?\n\nâœ¨ Â¡Dinos quÃ© buscas!`,\n\n`ðŸŽ *Â¡Genial! Hablemos de fragancias*\n\nÂ¿QuÃ© producto te interesa?\n- Â¿Tienes marca favorita?\n- Â¿Buscas algo nuevo?\n\nðŸš€ Â¡CompÃ¡rtenos tu preferencia!`,\n\n`ðŸ’³ *Â¡Listo para ayudarte!*\n\nÂ¿En quÃ© fragancia estÃ¡s interesado/a?\n- Â¿Algo en particular?\n- Â¿Necesitas recomendaciones?\n\nðŸŒŸ Â¡CuÃ©ntanos quÃ© buscas!`,\n\n`ðŸ›’ *Â¡Vamos a encontrar tu fragancia ideal!*\n\nÂ¿QuÃ© tipo de aroma prefieres?\n- Â¿Dulce, fresco, amaderado?\n- Â¿Para ocasiÃ³n especial?\n\nðŸ’Ž Â¡Dinos quÃ© te gusta!`,\n\n`ðŸŽ‰ *Â¡Perfecto! Descubramos tu fragancia*\n\nÂ¿QuÃ© producto tienes en mente?\n- Â¿Alguna marca especÃ­fica?\n- Â¿Buscas algo trending?\n\nâœ¨ Â¡Comparte tu interÃ©s!`,\n\n`ðŸ›ï¸ *Â¡Excelente elecciÃ³n!*\n\nÂ¿En quÃ© fragancia estÃ¡s pensando?\n- Â¿Algo clÃ¡sico o moderno?\n- Â¿Tienes preferencias?\n\nðŸ”¥ Â¡CuÃ©ntanos quÃ© buscas!`,\n\n`ðŸ’ *Â¡Hablemos de tu fragancia perfecta!*\n\nÂ¿QuÃ© tipo de aroma te interesa?\n- Â¿Para uso diario o especial?\n- Â¿Tienes alguna en mente?\n\nðŸŒˆ Â¡Dinos quÃ© prefieres!`,\n\n`ðŸŽŠ *Â¡Genial! Encontremos tu aroma*\n\nÂ¿QuÃ© fragancia te llama la atenciÃ³n?\n- Â¿Buscas algo especÃ­fico?\n- Â¿Necesitas sugerencias?\n\nðŸ’« Â¡Comparte tu gusto!`,\n\n`ðŸš€ *Â¡Perfecto! Hablemos de fragancias*\n\nÂ¿En quÃ© producto estÃ¡s interesado/a?\n- Â¿Tienes marca favorita?\n- Â¿Algo dulce o fresco?\n\nðŸŽ Â¡CuÃ©ntanos tu preferencia!`\n];\n\n// Selecciona uno al azar\nconst comprarAleatorio = comprar[Math.floor(Math.random() * comprar.length)];\nreturn [\n  {\n    json: {\n      output: comprarAleatorio\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2352,
        1320
      ],
      "id": "f494babf-7a04-4539-856e-0516a8e64b1c",
      "name": "Dynamic Buy"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.output.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2128,
        1320
      ],
      "id": "23526dbc-8458-41a3-bf8b-489d60bdb1d5",
      "name": "Send Dynamic Buy"
    },
    {
      "parameters": {
        "jsCode": "const consultarPedido = [\n`ðŸ“¦ *Â¡Perfecto! Consultemos tu pedido*\n\nÂ¿QuÃ© necesitas saber sobre tu compra?\n- Â¿Estado del envÃ­o?\n- Â¿NÃºmero de guÃ­a?\n- Â¿Tiempo de entrega?\n\nðŸšš Â¡Estamos aquÃ­ para ayudarte!`,\n\n`ðŸ” *Â¡Excelente! Revisemos tu orden*\n\nÂ¿Sobre quÃ© quieres consultar?\n- Â¿DÃ³nde estÃ¡ mi pedido?\n- Â¿CuÃ¡ndo llega?\n- Â¿Datos de envÃ­o?\n\nðŸ“‹ Â¡Dinos quÃ© necesitas saber!`,\n\n`ðŸ“± *Â¡Genial! Veamos tu pedido*\n\nÂ¿QuÃ© informaciÃ³n necesitas?\n- Â¿Estado actual del envÃ­o?\n- Â¿NÃºmero de seguimiento?\n- Â¿Fecha estimada de entrega?\n\nâœ¨ Â¡Consultemos juntos!`,\n\n`ðŸš› *Â¡Listo para ayudarte!*\n\nÂ¿QuÃ© quieres saber de tu compra?\n- Â¿EstÃ¡ en camino?\n- Â¿Tienes la guÃ­a?\n- Â¿AlgÃºn problema?\n\nðŸŒŸ Â¡Revisemos tu pedido!`,\n\n`ðŸ“¦ *Â¡Vamos a consultar tu envÃ­o!*\n\nÂ¿Sobre quÃ© necesitas informaciÃ³n?\n- Â¿Estado del pedido?\n- Â¿Seguimiento de envÃ­o?\n- Â¿Tiempo de llegada?\n\nðŸ’Ž Â¡Estamos para resolver tus dudas!`,\n\n`ðŸ”Ž *Â¡Perfecto! Consultemos tu orden*\n\nÂ¿QuÃ© informaciÃ³n buscas?\n- Â¿DÃ³nde estÃ¡ mi compra?\n- Â¿NÃºmero de guÃ­a?\n- Â¿CuÃ¡ndo llega?\n\nðŸŽ‰ Â¡Revisemos juntos!`,\n\n`ðŸ“‹ *Â¡Excelente! Veamos tu pedido*\n\nÂ¿QuÃ© necesitas consultar?\n- Â¿Estado de envÃ­o?\n- Â¿Datos de seguimiento?\n- Â¿InformaciÃ³n de entrega?\n\nðŸ”¥ Â¡Dinos quÃ© quieres saber!`,\n\n`ðŸšš *Â¡Consultemos tu compra!*\n\nÂ¿Sobre quÃ© tienes dudas?\n- Â¿Mi pedido ya saliÃ³?\n- Â¿CuÃ¡l es mi guÃ­a?\n- Â¿CuÃ¡ndo llega?\n\nðŸŒˆ Â¡Estamos para ayudarte!`,\n\n`ðŸ“± *Â¡Genial! Revisemos tu envÃ­o*\n\nÂ¿QuÃ© informaciÃ³n necesitas?\n- Â¿Estado actual?\n- Â¿NÃºmero de seguimiento?\n- Â¿Fecha de entrega?\n\nðŸ’« Â¡Consultemos tu pedido!`,\n\n`ðŸ” *Â¡Perfecto! Veamos tu orden*\n\nÂ¿QuÃ© quieres saber?\n- Â¿DÃ³nde estÃ¡ mi pedido?\n- Â¿GuÃ­a de envÃ­o?\n- Â¿Tiempo estimado?\n\nðŸŽ Â¡Resolvamos tus dudas!`\n];\n\n// Selecciona uno al azar\nconst consultarPedidoAleatorio = consultarPedido[Math.floor(Math.random() * consultarPedido.length)];\nreturn [\n  {\n    json: {\n      output: consultarPedidoAleatorio\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2352,
        1512
      ],
      "id": "4b89f8c1-4443-43b6-bd3e-a1171d93151c",
      "name": "Dynamic Order"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.output.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2128,
        1512
      ],
      "id": "96817423-3141-4258-94a6-028541ae10a2",
      "name": "Send Dynamic Order"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT estado_saludo_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1088,
        -128
      ],
      "id": "465fb9d3-87f0-42ce-a5a0-6fe61e580f7d",
      "name": "Execute Status Greeting",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT estado_catalogo_pro('{{ $('WhatsApp Message Parser').first().json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -784,
        832
      ],
      "id": "2a6d22fb-b01c-486a-b721-c4fec78c02f8",
      "name": "Execute Status Catalog",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT estado_ofertas_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1904,
        1128
      ],
      "id": "579ff869-7ef7-47c7-a6dd-2e0847b3a1bf",
      "name": "Execute Status Offers",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT estado_ventas_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1904,
        1320
      ],
      "id": "f887924d-1ac2-425b-8c78-888a02cbaa11",
      "name": "Execute Status Buy",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT estado_soporte_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1904,
        1512
      ],
      "id": "cb5c7a53-e0bc-436e-a646-c53486efa321",
      "name": "Execute Status Order",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('573011284297');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -336,
        316
      ],
      "id": "691810f7-b508-4535-a0ec-1066595bbece",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.estado }}",
                    "rightValue": "ventas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ventas-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "sales"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.estado }}",
                    "rightValue": "soporte",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "soporte-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "order"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -112,
        300
      ],
      "id": "f39dbf50-46b1-41d7-982b-5d62618d4362",
      "name": "Status Response IA"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        488,
        464
      ],
      "id": "f94a06b4-daa1-46bd-a908-dc31f834cf34",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        112,
        288
      ],
      "id": "9e582051-baa3-415f-ad0f-e092dccbd429",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "4I5hY4XwoALE8VJS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        240,
        288
      ],
      "id": "f11df4b4-4e83-45af-a8a3-9da25cf18419",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Recibes el siguiente mensaje:\n\n{{ $('Format Final Output').item.json.conversation_content }}",
        "options": {
          "systemMessage": "=# ðŸš¨ REGLA CRÃTICA: UNA SOLA HERRAMIENTA POR CONSULTA\n\n**IMPORTANTE**: Ejecuta **SOLO UNA HERRAMIENTA** por consulta del cliente. **NO REPITAS** llamadas.\n\n---\n\n## Contexto\n\nEres el **Router Agent Sales** especializado en la venta de perfumes y lociones. Tu trabajo es analizar la consulta del cliente y dirigirla al agente especializado correcto. **Nunca debes hacer recomendaciones directas ni manejar ventas**; solo necesitas llamar a **UNA SOLA** herramienta correcta.\n\n## âš¡ PROCESO OBLIGATORIO DE EJECUCIÃ“N\n\n### Paso 1: Analizar consulta\n\n### Paso 2: Elegir UNA herramienta\n\n### Paso 3: Ejecutar esa herramienta UNA SOLA VEZ\n\n### Paso 4: TERMINAR - No hacer mÃ¡s llamadas\n\n## Herramientas Disponibles\n\n- **`think_router_analysis`**: Usa esta herramienta **PRIMERO** para analizar consultas complejas o ambiguas antes de decidir quÃ© agente usar.\n- **`inventory_agent`**: Usa esta herramienta para consultas sobre productos especÃ­ficos, disponibilidad, precios y stock.\n- **`recommendation_agent`**: Usa esta herramienta para solicitudes de recomendaciones personalizadas y consejos de fragancias.\n- **`product_comparator_agent`**: Usa esta herramienta para comparar productos, caracterÃ­sticas y diferencias entre opciones.\n- **`sales_specialist_agent`**: Usa esta herramienta para cotizaciones, promociones, mÃ©todos de pago y cierre de ventas.\n\n## ðŸ”„ Contexto de ConversaciÃ³n\n\n**IMPORTANTE**: Tienes acceso a la **memoria de la conversaciÃ³n** a travÃ©s de Postgres Chat Memory. Usa esta informaciÃ³n para:\n\n- **Reconocer referencias** a productos mencionados anteriormente\n- **Entender el contexto** de preguntas de seguimiento\n- **Mantener continuidad** en la conversaciÃ³n\n- **Dirigir correctamente** consultas que dependen del historial\n- **DETECTAR PROCESOS DE VENTA EN CURSO** y mantener al cliente en sales_specialist_agent\n\n## ðŸ›’ DETECCIÃ“N DE PROCESO DE VENTA ACTIVO\n\n**REGLA CRÃTICA**: Si en el historial de conversaciÃ³n detectas que:\n\n- âœ… **Cliente ya solicitÃ³ 6+ lociones** (precio mayorista)\n- âœ… **Se iniciÃ³ un proceso de pedido**\n- âœ… **Ya se solicitaron datos del cliente** (nombre, telÃ©fono, direcciÃ³n)\n- âœ… **Cliente respondiÃ³ con sus datos personales**\n- âœ… **Hay cotizaciÃ³n en proceso**\n- âœ… **Se estÃ¡n discutiendo mÃ©todos de pago o envÃ­o**\n\n**â†’ SIEMPRE dirigir a `sales_specialist_agent`** hasta que se confirme que el pedido quedÃ³ completado.\n\n### Ejemplos de consultas que van a Sales Specialist:\n\n- *\"Mi nombre es Juan PÃ©rez\"* (respondiendo solicitud de datos)\n- *\"Mi telÃ©fono es 123456789\"* (completando informaciÃ³n)\n- *\"Prefiero pago contra entrega\"* (eligiendo mÃ©todo de pago)\n- *\"Â¿CuÃ¡ndo llega mi pedido?\"* (seguimiento de venta)\n- *\"Quiero cambiar la direcciÃ³n\"* (modificando datos)\n- *\"Â¿CuÃ¡nto es el total?\"* (confirmando cotizaciÃ³n)\n- Cualquier consulta cuando ya hay proceso de venta iniciado\n\n### Ejemplos de preguntas con contexto (SIN proceso de venta):\n\n- *\"Â¿CuÃ¡l de esos te gusta mÃ¡s?\"* â†’ `recommendation_agent`\n- *\"De los que me dijiste, Â¿cuÃ¡l dura mÃ¡s?\"* â†’ `product_comparator_agent`\n- *\"Â¿Tienes stock de ese Ãºltimo que mencionaste?\"* â†’ `inventory_agent`\n\n## ðŸ”„ Proceso de Trabajo Obligatorio\n\n1. **REVISAR HISTORIAL PRIMERO** - Verificar si hay proceso de venta activo\n2. **Si hay venta en curso** â†’ Dirigir automÃ¡ticamente a `sales_specialist_agent`\n3. **Si NO hay venta en curso** â†’ Evaluar la complejidad de la consulta\n4. **Si la consulta es compleja, ambigua o tiene mÃºltiples elementos**: Usa **PRIMERO** `think_router_analysis` **UNA SOLA VEZ**\n5. **Identifica el tipo de solicitud** segÃºn las reglas de clasificaciÃ³n\n6. **Llama a UNA SOLA herramienta apropiada** basÃ¡ndote en el anÃ¡lisis\n7. **DETENTE** - No hagas mÃ¡s llamadas\n\n## CuÃ¡ndo usar Think Tool PRIMERO\n\n- La consulta menciona mÃºltiples productos o conceptos\n- No estÃ¡ claro quÃ© informaciÃ³n busca el cliente\n- PodrÃ­an aplicar dos agentes diferentes\n- La consulta es muy general o ambigua\n- El cliente hace varias preguntas en una sola consulta\n\n## Reglas de ClasificaciÃ³n\n\n### Usar `inventory_agent` cuando:\n\n- El cliente pregunta por un producto especÃ­fico: *\"Â¿Tienes la lociÃ³n X?\"*\n- Consulta sobre disponibilidad: *\"Â¿EstÃ¡ disponible el perfume Y?\"*\n- Pregunta sobre precios: *\"Â¿CuÃ¡nto cuesta...?\"*\n- Busca informaciÃ³n de stock: *\"Â¿QuÃ© presentaciones tienes de...?\"*\n\n### Usar `recommendation_agent` cuando:\n\n- El cliente pide sugerencias: *\"Â¿QuÃ© me recomiendas?\"*\n- Busca por ocasiÃ³n: *\"Busco algo para el dÃ­a/noche\"*\n- Necesita orientaciÃ³n: *\"No sÃ© quÃ© elegir\"*\n- Busca regalos: *\"Â¿QuÃ© tienes para regalo?\"*\n- Menciona preferencias: *\"Me gustan las fragancias frescas\"*\n- **Preguntas de seguimiento sobre recomendaciones**: *\"Â¿CuÃ¡l te gusta mÃ¡s?\"*, *\"Â¿CuÃ¡l me recomiendas de esos?\"*\n- **Referencias a conversaciÃ³n anterior**: *\"De los que me dijiste...\"*, *\"De esas opciones...\"*\n- **Solicita opiniÃ³n personal**: *\"Â¿CuÃ¡l prefieres?\"*, *\"Â¿QuÃ© opinas?\"*\n- **Pide mÃ¡s detalles de recomendaciones**: *\"CuÃ©ntame mÃ¡s de...\"*, *\"Â¿Por quÃ© ese?\"*\n\n### Usar `product_comparator_agent` cuando:\n\n- Compara productos especÃ­ficos: *\"Â¿CuÃ¡l es mejor entre A y B?\"*\n- Pregunta por diferencias: *\"Â¿QuÃ© diferencia hay entre...?\"*\n- Busca caracterÃ­sticas: *\"Â¿CuÃ¡l dura mÃ¡s?\"*\n- Necesita pros y contras: *\"Â¿CuÃ¡l me conviene mÃ¡s?\"*\n- **Compara productos ya recomendados**: *\"Entre One Million y Invictus, Â¿cuÃ¡l es mejor?\"*\n- **EvaluaciÃ³n especÃ­fica**: *\"Â¿CuÃ¡l tiene mejor duraciÃ³n?\"*, *\"Â¿CuÃ¡l es mÃ¡s elegante?\"*\n\n### Usar `sales_specialist_agent` cuando:\n\n- EstÃ¡ listo para comprar: *\"Quiero comprar...\"*\n- Pide cotizaciÃ³n: *\"Â¿CuÃ¡nto me sale todo?\"*\n- Pregunta por promociones: *\"Â¿Hay descuentos?\"*\n- Consulta mÃ©todos de pago: *\"Â¿CÃ³mo puedo pagar?\"*\n- Pregunta por envÃ­o: *\"Â¿CuÃ¡nto cuesta el envÃ­o?\"*\n- **PROCESO DE VENTA ACTIVO**: Cuando ya hay venta en curso (6+ productos, datos solicitados, cotizaciÃ³n iniciada)\n- **Respuestas a datos solicitados**: Nombre, telÃ©fono, direcciÃ³n, etc.\n- **Seguimiento de pedido**: Modificaciones, confirmaciones, dudas sobre la venta\n- **Cualquier consulta durante proceso de compra activo**\n\n## Ejemplos con EjecuciÃ³n Ãšnica\n\n### Ejemplo 1: Consulta Simple\n\n**Input**: *\"Â¿Tienes la lociÃ³n Dolce & Gabbana Light Blue?\"*  \n**AcciÃ³n**: Llamar `inventory_agent` **UNA SOLA VEZ**  \n**Resultado**: Obtener respuesta y **TERMINAR**\n\n### Ejemplo 2: Consulta Compleja\n\n**Input**: *\"Busco algo elegante para regalo, pero no sÃ© si Hugo Boss o Calvin Klein, Â¿cuÃ¡l me recomiendas y cuÃ¡nto cuesta?\"*  \n**AcciÃ³n**: \n\n1. Llamar `think_router_analysis` **UNA SOLA VEZ**\n2. Llamar `product_comparator_agent` **UNA SOLA VEZ**\n3. **TERMINAR**\n\n### Ejemplo 3: Pregunta de Seguimiento\n\n**Input**: *\"De esas 3 que me recomendÃ³, Â¿cuÃ¡l te gusta mÃ¡s a ti?\"*  \n**AcciÃ³n**: Llamar `recommendation_agent` **UNA SOLA VEZ**  \n**Resultado**: El agente usa la memoria para recordar las 3 recomendaciones y dar su opiniÃ³n experta\n\n### Ejemplo 4: ComparaciÃ³n con Contexto\n\n**Input**: *\"Entre One Million y Versace Eros que me dijiste, Â¿cuÃ¡l dura mÃ¡s?\"*  \n**AcciÃ³n**: Llamar `product_comparator_agent` **UNA SOLA VEZ**  \n**Resultado**: Comparar especÃ­ficamente esos dos productos mencionados anteriormente\n\n### Ejemplo 5: Proceso de Venta Activo\n\n**Input**: *\"Mi nombre es Juan PÃ©rez y mi telÃ©fono es 123456789\"*  \n**Historial**: Cliente ya pidiÃ³ 6 lociones y se le solicitaron datos  \n**AcciÃ³n**: Llamar `sales_specialist_agent` **UNA SOLA VEZ**  \n**Resultado**: Continuar con el proceso de venta sin interrupciones\n\n## ðŸ§© DETECCIÃ“N DE DATOS PARCIALES DURANTE VENTA\n\nCuando un cliente empieza a enviar sus datos personales, pero aÃºn no ha completado todos los campos requeridos, **DEBES mantener el flujo activo en `sales_specialist_agent`** hasta completar la recolecciÃ³n total y confirmaciÃ³n final.\n\n### ðŸ“‹ Datos requeridos para confirmar la venta:\n\n- âœ… Nombre\n- âœ… TelÃ©fono\n- âœ… DirecciÃ³n\n- âœ… Ciudad\n- âœ… MÃ©todo de Pago\n\n---\n\n### ðŸ§  LÃ³gica de flujo:\n\n1. **Si el cliente ha enviado solo algunos de los datos anteriores**  \n   â†’ **Continuar en `sales_specialist_agent` para pedir lo faltante**.\n\n2. **Si el cliente ha enviado todos los datos pero aÃºn no confirma precios o direcciÃ³n**  \n   â†’ **Seguir en `sales_specialist_agent` hasta que dÃ© su confirmaciÃ³n final**.\n\n3. **Si el cliente ya confirmÃ³ todo (datos, mÃ©todo de pago y total)**  \n   â†’ **Considerar la venta confirmada y permitir finalizar el flujo**.\n\n---\n\n### ðŸ’¬ Ejemplos de detecciÃ³n (ventas parciales activas)\n\n| Cliente diceâ€¦                 | AcciÃ³n esperada                                             |\n| ----------------------------- | ----------------------------------------------------------- |\n| â€œMi nombre es Lauraâ€          | `sales_specialist_agent`                                    |\n| â€œMi telÃ©fono es 312â€¦â€         | `sales_specialist_agent`                                    |\n| â€œPrefiero contra entregaâ€     | `sales_specialist_agent`                                    |\n| â€œCalle 56 sur #12-45, BogotÃ¡â€ | `sales_specialist_agent`                                    |\n| â€œEstÃ¡ bien, eso pagoâ€         | `sales_specialist_agent` si aÃºn no confirma todos los datos |\n\n---\n\n### ðŸš« NO CAMBIAR DE AGENTE si:\n\n- AÃºn falta confirmar datos personales completos\n- El cliente no ha validado el mÃ©todo de pago\n- El cliente no ha dicho que todo estÃ¡ correcto\n\n---\n\n### âœ… Ejemplo de cierre correcto\n\n**Cliente**: â€œEntonces me llega a MedellÃ­n, pago contra entrega, y son $89.000 cierto?â€  \n**TÃº**: Confirmas total y pides validaciÃ³n.  \n**Cliente**: â€œSÃ­, estÃ¡ perfecto. EnvÃ­alo.â€  \nâœ… Venta confirmada â†’ flujo puede considerarse completado\n\n---\n\nMantÃ©n `sales_specialist_agent` activo hasta que el cliente confirme TODO.\n\n\n\n\n### Ejemplo 6: Seguimiento de Venta\n\n**Input**: *\"Â¿CuÃ¡ndo llega mi pedido?\"*  \n**Historial**: Ya hay cotizaciÃ³n y datos del cliente  \n**AcciÃ³n**: Llamar `sales_specialist_agent` **UNA SOLA VEZ**  \n**Resultado**: Gestionar el seguimiento de la venta\n\n## ðŸš« LO QUE NUNCA DEBES HACER\n\n- âŒ **NO** llames `inventory_agent` dos veces\n- âŒ **NO** llames mÃºltiples herramientas para la misma consulta\n- âŒ **NO** repitas llamadas para \"confirmar\" o \"verificar\"\n- âŒ **NO** hagas llamadas adicionales despuÃ©s de obtener una respuesta\n- âŒ **NO** uses multiple function calls en una sola respuesta\n\n## âœ… LO QUE SÃ DEBES HACER\n\n- âœ… **Analizar** â†’ **Elegir UNA herramienta** â†’ **Ejecutar UNA VEZ** â†’ **TERMINAR**\n- âœ… Confiar en la primera respuesta de la herramienta\n- âœ… Una consulta = Una herramienta = Una ejecuciÃ³n = Trabajo completado\n\n## PriorizaciÃ³n para Consultas Ambiguas\n\n**1. PRIMERA PRIORIDAD**: Si hay proceso de venta activo â†’ `sales_specialist_agent`\n\nSi NO hay venta en curso y despuÃ©s del anÃ¡lisis aÃºn hay dudas, prioriza en este orden:\n\n2. **Recommendation Agent** (para seguimientos de recomendaciones y opiniones)\n3. **Product Comparator Agent** (para comparaciones especÃ­ficas)\n4. **Inventory Agent** (para productos especÃ­ficos mencionados)\n5. **Sales Specialist Agent** (para compras nuevas)\n\n## ðŸ” DetecciÃ³n de Preguntas de Seguimiento\n\n**Palabras clave que indican contexto/seguimiento:**\n\n- \"esas\", \"esos\", \"los que\", \"las que\"\n- \"me dijiste\", \"me recomendaste\", \"mencionaste\"\n- \"de los anteriores\", \"del Ãºltimo\", \"de esas opciones\"\n- \"cuÃ¡l te gusta\", \"quÃ© opinas\", \"cuÃ¡l prefieres\"\n- \"entre X y Y que...\", \"comparando los...\"\n\n**â†’ Estas siempre van a `recommendation_agent` o `product_comparator_agent`**\n\n## Flujo de DecisiÃ³n RÃ¡pido\n\n```\nÂ¿Hay proceso de venta activo en el historial?\nâ”œâ”€ SÃ â†’ sales_specialist_agent UNA VEZ â†’ TERMINAR\nâ””â”€ NO â†’ Continuar anÃ¡lisis normal:\n    Â¿Es la consulta simple y directa? \n    â”œâ”€ SÃ â†’ Llamar agente directamente UNA VEZ â†’ TERMINAR\n    â””â”€ NO â†’ think_router_analysis UNA VEZ â†’ Decidir agente â†’ Ejecutar UNA VEZ â†’ TERMINAR\n```\n\n---\n\n## ðŸŽ¯ RECORDATORIO FINAL\n\n**TU ÃšNICA MISIÃ“N**: Recibir consulta â†’ Elegir UNA herramienta â†’ Ejecutarla UNA VEZ â†’ Entregar resultado\n\n**NO HAGAS NADA MÃS DESPUÃ‰S DE OBTENER UNA RESPUESTA**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        400,
        64
      ],
      "id": "2c07aa6e-4dbf-4a99-95c4-043055e12a20",
      "name": "Router Agent Sales"
    },
    {
      "parameters": {
        "name": "inventory_agent",
        "description": "Herramienta especializada para consultar el inventario completo de perfumes y lociones. Busca productos por nombre o marca, verifica disponibilidad en tiempo real, obtiene precios actuales y proporciona informaciÃ³n detallada de productos especÃ­ficos del catÃ¡logo.",
        "workflowId": {
          "__rl": true,
          "value": "l0HpKncxwOEcFy8h",
          "mode": "list",
          "cachedResultName": "My Sub Inventory Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        368,
        288
      ],
      "id": "88ec7328-6c93-40d9-96ba-246031344e92",
      "name": "inventory_agent"
    },
    {
      "parameters": {
        "description": "Analiza la consulta del cliente sobre perfumes y lociones para determinar quÃ© agente especializado debe manejar la solicitud.\n\nPROCESA LA CONSULTA ANALIZANDO:\n1. Â¿Menciona un producto especÃ­fico por nombre/marca?\n2. Â¿Pide recomendaciones o sugerencias?\n3. Â¿EstÃ¡ comparando productos o preguntando diferencias?\n4. Â¿Muestra intenciÃ³n de compra o solicita informaciÃ³n comercial?\n\nCLASIFICACIÃ“N POR AGENTE:\n\nðŸ” INVENTORY AGENT - Usar cuando:\n- Pregunta por producto especÃ­fico: \"Â¿Tienes Hugo Boss?\"\n- Consulta disponibilidad: \"Â¿EstÃ¡ disponible X perfume?\"\n- Pregunta precios: \"Â¿CuÃ¡nto cuesta la lociÃ³n Y?\"\n- Busca stock/presentaciones: \"Â¿QuÃ© tamaÃ±os tienes?\"\n\nðŸ’¡ RECOMMENDATION AGENT - Usar cuando:\n- Pide sugerencias: \"Â¿QuÃ© me recomiendas?\"\n- Busca por ocasiÃ³n: \"Algo para el dÃ­a/trabajo/noche\"\n- No sabe quÃ© elegir: \"AyÃºdame a elegir\"\n- Busca regalos: \"Para mi esposa/novio\"\n- Menciona preferencias: \"Me gustan las fragancias frescas\"\n\nâš–ï¸ COMPARATOR AGENT - Usar cuando:\n- Compara productos: \"Â¿CuÃ¡l es mejor entre A y B?\"\n- Pregunta diferencias: \"Â¿QuÃ© diferencia hay entre X y Y?\"\n- Busca caracterÃ­sticas: \"Â¿CuÃ¡l dura mÃ¡s?\"\n- Pros/contras: \"Â¿CuÃ¡l me conviene?\"\n\nðŸ’° SALES SPECIALIST AGENT - Usar cuando:\n- Listo para comprar: \"Quiero comprar esto\"\n- Pide cotizaciÃ³n: \"Â¿CuÃ¡nto me sale todo?\"\n- Pregunta promociones: \"Â¿Hay descuentos?\"\n- MÃ©todos de pago: \"Â¿CÃ³mo puedo pagar?\"\n- InformaciÃ³n de envÃ­o: \"Â¿CuÃ¡nto cuesta el envÃ­o?\"\n\nPIENSA ESPECIALMENTE CUANDO:\n- La consulta es ambigua o tiene mÃºltiples elementos\n- No estÃ¡ claro quÃ© informaciÃ³n busca el cliente\n- PodrÃ­an aplicar dos agentes diferentes\n- Necesitas decidir prioridades\n\nEJEMPLO DE ANÃLISIS:\nCliente: \"Busco algo bueno para regalar a mi novia\"\nAnÃ¡lisis: No menciona producto especÃ­fico + Es regalo + Necesita orientaciÃ³n personalizada = RECOMMENDATION AGENT"
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        496,
        288
      ],
      "id": "9afbae46-9e8f-414a-afcc-c293900112b5",
      "name": "think_router_analysis"
    },
    {
      "parameters": {
        "name": "recommendation_agent",
        "description": "Agente especializado en recomendaciones de fragancias que analiza las preferencias del cliente, ocasiÃ³n de uso, presupuesto y estilo personal para sugerir los perfumes y lociones mÃ¡s adecuados del catÃ¡logo disponible.",
        "workflowId": {
          "__rl": true,
          "value": "8xMoAwEO7wUKJTXi",
          "mode": "list",
          "cachedResultName": "My Sub Recommendation Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        624,
        288
      ],
      "id": "52c01ab0-8c98-48a2-acdd-7d1184d8359a",
      "name": "recommendation_agent"
    },
    {
      "parameters": {
        "name": "product_comparator_agent",
        "description": "Agente experto en comparaciones de fragancias que evalÃºa y contrasta productos especÃ­ficos, analizando diferencias en aroma, durabilidad, ocasiÃ³n de uso, precio y caracterÃ­sticas para ayudar al cliente a elegir la mejor opciÃ³n entre alternativas.",
        "workflowId": {
          "__rl": true,
          "value": "4HlRidEr8jDW0Zan",
          "mode": "list",
          "cachedResultName": "My Sub Product Comparator Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        752,
        288
      ],
      "id": "2e327026-e4ac-47c2-a326-e276b54417dd",
      "name": "product_comparator_agent"
    },
    {
      "parameters": {
        "name": "sales_specialist_agent",
        "description": "Agente experto en ventas especializado en cerrar transacciones, generar cotizaciones personalizadas, ofrecer promociones vigentes, explicar mÃ©todos de pago disponibles y gestionar todo el proceso de compra hasta la finalizaciÃ³n.",
        "workflowId": {
          "__rl": true,
          "value": "Tk1Yk7Bhqs7KvV9o",
          "mode": "list",
          "cachedResultName": "My Sub Sales Specialist Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        880,
        288
      ],
      "id": "f114e4d9-584c-4726-b683-b260dfedff57",
      "name": "sales_specialist_agent"
    }
  ],
  "pinData": {},
  "connections": {
    "WhatsApp Message Parser": {
      "main": [
        [
          {
            "node": "Message Type Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "WhatsApp Message Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Router": {
      "main": [
        [
          {
            "node": "Download Audio File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pausa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Image File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Button Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio File": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image File": {
      "main": [
        [
          {
            "node": "Analyze Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pausa": {
      "main": [
        [
          {
            "node": "Obtener Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Extract Message Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Image": {
      "main": [
        [
          {
            "node": "Extract Message Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Button Response": {
      "main": [
        [
          {
            "node": "Button Response Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Button Response Router": {
      "main": [
        [
          {
            "node": "Dynamic Time Greeting",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dynamic Offers",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dynamic Buy",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dynamic Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Texto": {
      "main": [
        [
          {
            "node": "Extract Message Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message Content": {
      "main": [
        [
          {
            "node": "Store Message in Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Message in Buffer": {
      "main": [
        [
          {
            "node": "Wait for Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Buffer": {
      "main": [
        [
          {
            "node": "Retrieve Messages from Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retrieve Messages from Buffer": {
      "main": [
        [
          {
            "node": "Check for Duplicate Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Duplicate Message": {
      "main": [
        [
          {
            "node": "Clear Buffer Cache",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip Duplicate Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Buffer Cache": {
      "main": [
        [
          {
            "node": "Format Final Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Final Output": {
      "main": [
        [
          {
            "node": "Get session_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get session_id": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Dynamic Greeting",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Greeting": {
      "main": [
        [
          {
            "node": "Send Dynamic Greeting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Time Greeting": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Download Good Morning",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Good Afternoon",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download  Good Night",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Greeting": {
      "main": [
        [
          {
            "node": "Send Buttons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Audio": {
      "main": [
        [
          {
            "node": "Send Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Audio": {
      "main": [
        [
          {
            "node": "Send Catalog Man",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Catalog Man": {
      "main": [
        [
          {
            "node": "Send Catalog Women",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Good Morning": {
      "main": [
        [
          {
            "node": "Merge Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Good Afternoon": {
      "main": [
        [
          {
            "node": "Merge Audio",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Download  Good Night": {
      "main": [
        [
          {
            "node": "Merge Audio",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Dynamic Offers": {
      "main": [
        [
          {
            "node": "Send Dynamic Offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Buy": {
      "main": [
        [
          {
            "node": "Send Dynamic Buy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Order": {
      "main": [
        [
          {
            "node": "Send Dynamic Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Buttons": {
      "main": [
        [
          {
            "node": "Execute Status Greeting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Catalog Women": {
      "main": [
        [
          {
            "node": "Execute Status Catalog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Offers": {
      "main": [
        [
          {
            "node": "Execute Status Offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Buy": {
      "main": [
        [
          {
            "node": "Execute Status Buy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Order": {
      "main": [
        [
          {
            "node": "Execute Status Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Status Response IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Response IA": {
      "main": [
        [
          {
            "node": "Router Agent Sales",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Router Agent Sales",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Router Agent Sales",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "inventory_agent": {
      "ai_tool": [
        [
          {
            "node": "Router Agent Sales",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "think_router_analysis": {
      "ai_tool": [
        [
          {
            "node": "Router Agent Sales",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "recommendation_agent": {
      "ai_tool": [
        [
          {
            "node": "Router Agent Sales",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "product_comparator_agent": {
      "ai_tool": [
        [
          {
            "node": "Router Agent Sales",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "sales_specialist_agent": {
      "ai_tool": [
        [
          {
            "node": "Router Agent Sales",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "48d6100e-2045-4730-bb4f-18122898397f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9b741fad69cc6219b90142a4f3a46a45de0510680dd2fdf57a5402cd3a1e0176"
  },
  "id": "NARCxPg3jEuCsBaJ",
  "tags": []
}