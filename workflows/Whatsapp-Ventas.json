{
  "name": "Whatsapp-Ventas",
  "nodes": [
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f1f4f21d-7bac-4148-8fa5-eb91e67e3f5e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "53ea1f96-c52a-4d1f-a00d-c0cafb1feb82"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b2b2b2b2-2222-3333-4444-555555555555"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message_type }}",
                    "rightValue": "button_response",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c3c3c3c3-3333-4444-5555-666666666666"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "button"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3776,
        -2912
      ],
      "id": "f9002aa7-3b10-42c8-811e-09fad4cad0c8",
      "name": "Message Type Router"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "credentials-object",
              "name": "credentials",
              "value": "={{ { \"z_api_token\": $json.headers['z-api-token'], \"instance_id\": $json.body.instanceId } }}",
              "type": "object"
            },
            {
              "id": "system-object",
              "name": "system",
              "value": "={{ { \"execution_mode\": $json.executionMode, \"webhook_url\": $json.webhookUrl, \"user_agent\": $json.headers['user-agent'], \"origin_server\": $json.headers.origin, \"client_ip\": $json.headers['x-real-ip'] } }}",
              "type": "object"
            },
            {
              "id": "user-object",
              "name": "user",
              "value": "={{ { \"sender_phone\": $json.body.phone, \"connected_phone\": $json.body.connectedPhone, \"chat_name\": $json.body.chatName, \"sender_name\": $json.body.senderName, \"chat_lid\": $json.body.chatLid } }}",
              "type": "object"
            },
            {
              "id": "message-type-detector",
              "name": "message_type",
              "value": "={{ $json.body.text ? 'text' : $json.body.audio ? 'audio' : $json.body.image ? 'image' : $json.body.buttonsResponseMessage ? ($json.body.buttonsResponseMessage.buttonId === 'confirmar_pedido' ? 'text' : 'button_response') : $json.body.document ? ($json.body.document.mimeType && $json.body.document.mimeType.startsWith('audio/') ? 'audio_file' : $json.body.document.mimeType && $json.body.document.mimeType.startsWith('video/') ? 'video' : 'document') : 'unknown' }}",
              "type": "string"
            },
            {
              "id": "message-object",
              "name": "message",
              "value": "={{ { \"message_id\": $json.body.messageId, \"timestamp\": $json.body.momment, \"formatted_date\": DateTime.fromMillis($json.body.momment).toFormat('yyyy-MM-dd HH:mm:ss'), \"formatted_date_utc_minus_5\": DateTime.fromMillis($json.body.momment).setZone('UTC-5').toFormat('yyyy-MM-dd HH:mm:ss'), \"message_status\": $json.body.status, \"message_type\": ($json.body.text ? 'text' : $json.body.audio ? 'audio' : $json.body.image ? 'image' : $json.body.buttonsResponseMessage ? ($json.body.buttonsResponseMessage.buttonId === 'confirmar_pedido' ? 'text' : 'button_response') : $json.body.document ? ($json.body.document.mimeType && $json.body.document.mimeType.startsWith('audio/') ? 'audio_file' : $json.body.document.mimeType && $json.body.document.mimeType.startsWith('video/') ? 'video' : 'document') : 'unknown') } }}",
              "type": "object"
            },
            {
              "id": "content-text",
              "name": "text_content",
              "value": "={{ $json.body.text ? { \"message\": $json.body.text.message } : ($json.body.buttonsResponseMessage && $json.body.buttonsResponseMessage.buttonId === 'confirmar_pedido') ? { \"message\": $json.body.buttonsResponseMessage.buttonId } : null }}",
              "type": "object"
            },
            {
              "id": "content-audio",
              "name": "audio_content",
              "value": "={{ $json.body.audio ? { \"audio_url\": $json.body.audio.audioUrl, \"duration_seconds\": $json.body.audio.seconds, \"mime_type\": $json.body.audio.mimeType, \"is_ptt\": $json.body.audio.ptt, \"view_once\": $json.body.audio.viewOnce, \"source\": 'audio_object' } : null }}",
              "type": "object"
            },
            {
              "id": "content-audio-file",
              "name": "audio_file_content",
              "value": "={{ ($json.body.document && $json.body.document.mimeType && $json.body.document.mimeType.startsWith('audio/')) ? { \"audio_url\": $json.body.document.documentUrl, \"file_name\": $json.body.document.fileName, \"mime_type\": $json.body.document.mimeType, \"caption\": $json.body.document.caption, \"title\": $json.body.document.title, \"source\": 'document_object' } : null }}",
              "type": "object"
            },
            {
              "id": "content-image",
              "name": "image_content",
              "value": "={{ $json.body.image ? { \"image_url\": $json.body.image.imageUrl, \"thumbnail_url\": $json.body.image.thumbnailUrl, \"caption\": $json.body.image.caption, \"mime_type\": $json.body.image.mimeType, \"view_once\": $json.body.image.viewOnce, \"width\": $json.body.image.width, \"height\": $json.body.image.height } : null }}",
              "type": "object"
            },
            {
              "id": "content-video",
              "name": "video_content",
              "value": "={{ ($json.body.document && $json.body.document.mimeType && $json.body.document.mimeType.startsWith('video/')) ? { \"video_url\": $json.body.document.documentUrl, \"file_name\": $json.body.document.fileName, \"mime_type\": $json.body.document.mimeType, \"caption\": $json.body.document.caption, \"title\": $json.body.document.title, \"source\": 'document_object' } : null }}",
              "type": "object"
            },
            {
              "id": "content-document",
              "name": "document_content",
              "value": "={{ ($json.body.document && (!$json.body.document.mimeType || (!$json.body.document.mimeType.startsWith('audio/') && !$json.body.document.mimeType.startsWith('video/')))) ? { \"document_url\": $json.body.document.documentUrl, \"file_name\": $json.body.document.fileName, \"title\": $json.body.document.title, \"caption\": $json.body.document.caption, \"mime_type\": $json.body.document.mimeType, \"page_count\": $json.body.document.pageCount } : null }}",
              "type": "object"
            },
            {
              "id": "content-button",
              "name": "button_content",
              "value": "={{ $json.body.buttonsResponseMessage ? { \"button_id\": $json.body.buttonsResponseMessage.buttonId, \"button_text\": $json.body.buttonsResponseMessage.message, \"button_response\": $json.body.buttonsResponseMessage.buttonId, \"display_text\": $json.body.buttonsResponseMessage.message } : null }}",
              "type": "object"
            },
            {
              "id": "flags-object",
              "name": "flags",
              "value": "={{ { \"from_me\": $json.body.fromMe, \"is_group\": $json.body.isGroup, \"is_newsletter\": $json.body.isNewsletter, \"is_forwarded\": $json.body.forwarded, \"is_broadcast\": $json.body.broadcast, \"callback_type\": $json.body.type, \"from_api\": $json.body.fromApi, \"is_status_reply\": $json.body.isStatusReply, \"is_edit\": $json.body.isEdit, \"waiting_message\": $json.body.waitingMessage, \"message_expiration_seconds\": $json.body.messageExpirationSeconds || 0 } }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4000,
        -2880
      ],
      "id": "17fb5885-f27b-4f68-90c8-b6b96cf2e303",
      "name": "WhatsApp Message Parser"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "50a91089-2c34-4dd0-8896-2715bd6e9612",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -4224,
        -2880
      ],
      "id": "ffa00552-1e78-42d5-bc33-8adfe00eba8f",
      "name": "Webhook",
      "webhookId": "50a91089-2c34-4dd0-8896-2715bd6e9612"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -3552,
        -2944
      ],
      "id": "631c2fd9-0166-4e3d-a5b5-957cd07fe429",
      "name": "Pausa",
      "webhookId": "0bfa0972-a628-48bb-be5d-b3c30b33df0e"
    },
    {
      "parameters": {
        "url": "={{ $json.audio_content.audio_url }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3552,
        -3136
      ],
      "id": "45d94ef5-90dc-4474-9b36-32a4a1a8b335",
      "name": "Download Audio File"
    },
    {
      "parameters": {
        "url": "={{ $json.image_content.image_url }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3552,
        -2752
      ],
      "id": "31279314-00db-4ba0-9c50-414d66d75db8",
      "name": "Download Image File"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "# Instrucciones para DescripciÃ³n de Imagen\nDescribe esta imagen en espaÃ±ol.",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -3328,
        -2752
      ],
      "id": "97f71125-e2da-4d8a-830d-41e6bf9b4bc0",
      "name": "Analyze Image",
      "credentials": {
        "openAiApi": {
          "id": "4I5hY4XwoALE8VJS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "button-response-id",
              "name": "button_id",
              "value": "={{ $json.button_content.button_id }}",
              "type": "string"
            },
            {
              "id": "button-response-text",
              "name": "button_text",
              "value": "={{ $json.button_content.button_text || $json.button_content.display_text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3552,
        -624
      ],
      "id": "17c65683-b3e5-41ad-b852-667156182e46",
      "name": "Process Button Response"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "catalogo",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "catalog-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Catalogo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "ofertas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "offers-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ofertas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "comprar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "buy-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Comprar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "order-button-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Pedido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ca097790-b652-48d1-8181-c16fcef7a6bd",
                    "leftValue": "={{ ['contra_entrega', 'interrapidisimo'].includes($json.button_id) }}",
                    "rightValue": "contra_entrega",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Contra_Entrega"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0aab0b48-271c-4b6d-85d1-4ae926a7829a",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "transferencia",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Transferencia"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e3943a52-8a51-413b-a5f2-89c394584dc5",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "modificar_producto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "modificar_producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bae55070-387b-41d8-9c87-9b671231afb3",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "modificar_pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "modificar_pedido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c6c49f16-27fd-4763-bde2-d5b388e27b6f",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "confirmar_pedido",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "confirmar_pedido"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3328,
        -1888
      ],
      "id": "30a4ef91-f37a-40c8-9b40-40b6d27aafb2",
      "name": "Button Response Router"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -3328,
        -3136
      ],
      "id": "d1eeb6c9-6519-443f-bd28-1a505862552c",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "4I5hY4XwoALE8VJS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
              "name": "mensaje",
              "type": "string",
              "value": "={{ $json.text || $json.content || $json.button_text || $json.button_id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "effe04df-e0d9-498e-ac7a-ae459b737065",
      "name": "Extract Message Content",
      "type": "n8n-nodes-base.set",
      "position": [
        -3104,
        -2944
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d4b9efeb-9a68-43e3-bc4c-cd207510bddf",
              "name": "text",
              "value": "={{ $json.text_content.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3328,
        -2944
      ],
      "id": "9f9b3420-0c4c-42d4-ac0f-12b53be579a1",
      "name": "Obtener Texto"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2880,
        -2944
      ],
      "id": "8eba6705-1fb5-42d7-992b-0416c436f626",
      "name": "Store Message in Buffer",
      "credentials": {
        "redis": {
          "id": "HBZtjEwzw7Xu4Gm2",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -2656,
        -2944
      ],
      "id": "f2c7accf-5fe7-43a9-9c01-5765abb21a3c",
      "name": "Wait for Buffer",
      "webhookId": "05929f0b-cb6a-48f9-901e-bbefe359f336"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2432,
        -2944
      ],
      "id": "dd07a6d7-1e99-43ef-97f3-250a39386463",
      "name": "Retrieve Messages from Buffer",
      "credentials": {
        "redis": {
          "id": "HBZtjEwzw7Xu4Gm2",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "87d5a006-5e35-4dbf-a3dc-e5420b918845",
              "leftValue": "={{ $json.propertyName.last() }}",
              "rightValue": "={{ $('Extract Message Content').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2208,
        -2944
      ],
      "id": "3d70eb9e-22d9-46f3-8238-23b6f9c20902",
      "name": "Check for Duplicate Message"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1984,
        -3120
      ],
      "id": "8ba6f68c-e89d-46a4-af85-eb592269c4af",
      "name": "Clear Buffer Cache",
      "credentials": {
        "redis": {
          "id": "HBZtjEwzw7Xu4Gm2",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1984,
        -2928
      ],
      "id": "b82d24c5-afdc-439a-ab07-8ea757c95423",
      "name": "Skip Duplicate Message"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f6459d32-0468-4e3c-8572-7b36e1fc2172",
              "name": "conversation_content",
              "value": "={{ $json.propertyName.join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1760,
        -3120
      ],
      "id": "00d6ed8e-6c74-4206-91ea-d6077bd5bf4c",
      "name": "Format Final Output"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    '{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}' as session_id,\n    CASE \n        WHEN NOT EXISTS (\n            SELECT 1 \n            FROM n8n_pro_conversation_states \n            WHERE session_id = '{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}'\n        ) THEN false  -- No hay registros, no existe\n        WHEN EXISTS (\n            SELECT 1 \n            FROM n8n_pro_conversation_states \n            WHERE session_id = '{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}'\n            AND ultima_actividad = (\n                SELECT MAX(ultima_actividad) \n                FROM n8n_pro_conversation_states \n                WHERE session_id = '{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}'\n            )\n            AND estado_actual = 'ventas' \n            AND estado_ventas = 'FIN'\n        ) THEN false  -- El mÃ¡s reciente estÃ¡ finalizado, no existe (crear nuevo)\n        ELSE true     -- En cualquier otro caso, existe\n    END as existe",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1536,
        -3120
      ],
      "id": "dbc9ff47-0a7e-4a99-8c49-1a7f32b61679",
      "name": "Get session_id",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7500bd18-477a-4fbe-b21d-ea6bbcc0a5d5",
              "leftValue": "={{ $json.existe }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1312,
        -3120
      ],
      "id": "402f07b1-bcc0-4399-b353-f3c303b7f626",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Obtener hora UTC y ajustarla a UTC-5\nconst ahora = new Date();\nconst horaUTC = ahora.getUTCHours();\nconst horaUTC5 = (horaUTC + 24 - 5) % 24;\n\n// Determinar perÃ­odo del dÃ­a\nlet periodo = '';\n\nif (horaUTC5 >= 5 && horaUTC5 < 12) {\n  periodo = 'maÃ±ana';\n} else if (horaUTC5 >= 12 && horaUTC5 < 18) {\n  periodo = 'tarde';\n} else {\n  periodo = 'noche';\n}\n\n// Retornar perÃ­odo junto con datos necesarios\nreturn [\n  {\n    json: {\n      periodo: periodo,\n      hora: horaUTC5,\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3104,
        -2496
      ],
      "id": "13ca9a46-52df-42b4-89ae-257a5b222061",
      "name": "Dynamic Time Greeting"
    },
    {
      "parameters": {
        "jsCode": "const saludos = [\n`ðŸŒ¸ Â¡Hola! Gracias por escribir a *Ed PerfumerÃ­a*  \nEstamos encantados de ayudarte a encontrar la fragancia ideal.`,\n\n`ðŸ’¬ Â¡Bienvenido a *Ed PerfumerÃ­a*!  \nGracias por elegirnos para tu prÃ³xima compra de perfumes.`,\n\n`ðŸŽ‰ Â¡Hola! QuÃ© gusto tenerte en *Ed PerfumerÃ­a*  \nEstamos aquÃ­ para ayudarte a encontrar tu aroma perfecto.`,\n\n`ðŸŒŸ Â¡Gracias por comunicarte con *Ed PerfumerÃ­a*!  \nNos alegra poder atenderte ðŸ˜Š`,\n\n`ðŸš€ Â¡Hola y bienvenido a *Ed PerfumerÃ­a*!  \nEs un placer atenderte hoy âœ¨`,\n\n`ðŸ™Œ Â¡Hola! Gracias por escribir a *Ed PerfumerÃ­a*  \nEstamos encantados de atenderte. ðŸ’`,\n\n`ðŸ‘‹ Â¡Bienvenid@ a *Ed PerfumerÃ­a*!  \nNos alegra recibir tu mensaje. ðŸ’–`,\n\n`âœ¨ Â¡Hola! Gracias por contactar a *Ed PerfumerÃ­a*  \nNos alegra mucho tenerte por aquÃ­ ðŸ˜Š`,\n\n`ðŸŒŸ Â¡Gracias por comunicarte con *Ed PerfumerÃ­a*!  \nEstamos aquÃ­ para ayudarte a encontrar tu fragancia ideal. ðŸ§´âœ¨`,\n\n`ðŸŽ‰ Â¡Bienvenido a *Ed PerfumerÃ­a*!  \nGracias por escribirnos. Estamos listos para asesorarte.`\n];\n\n// Selecciona uno al azar\nconst saludoAleatorio = saludos[Math.floor(Math.random() * saludos.length)];\nreturn [\n  {\n    json: {\n      output: saludoAleatorio\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1088,
        -3408
      ],
      "id": "2df74dd9-444b-4ea6-b9ea-255bcfb56430",
      "name": "Dynamic Greeting"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.periodo }}",
                    "rightValue": "maÃ±ana",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "eb8f4c83-efd2-4595-b674-25dc1c0ad1b8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "maÃ±ana"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dcc3cd98-a426-4020-8af1-a851981f2055",
                    "leftValue": "={{ $json.periodo }}",
                    "rightValue": "tarde",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarde"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b515e6bc-c3a2-4471-b9ee-ff723e6ff6cc",
                    "leftValue": "={{ $json.periodo }}",
                    "rightValue": "noche",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "noche"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2880,
        -2512
      ],
      "id": "697e2e72-659f-4d40-9f4a-7f38e42133c7",
      "name": "Switch1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "=F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.output.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -864,
        -3408
      ],
      "id": "2d81bb88-ee3a-4e04-94ba-7e8f6964b238",
      "name": "Send Dynamic Greeting"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}\",\n  \"message\": \"{{ (() => { const h = new Date(new Date().getTime() - 18000000).getHours(); return h >= 5 && h < 12 ? 'Â¡Buenos dÃ­as!' : h >= 12 && h < 18 ? 'Â¡Buenas tardes!' : 'Â¡Buenas noches!'; })() }} ðŸŒ¸\\n\\nÂ¿QuÃ© te gustarÃ­a hacer?\",\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"buttons\": [\n      {\n        \"id\": \"comprar\",\n        \"label\": \"ðŸ›’ Comprar\"\n      },\n      {\n        \"id\": \"catalogo\",\n        \"label\": \"ðŸ“‹ CatÃ¡logo\"\n      },\n      {\n        \"id\": \"ofertas\",\n        \"label\": \"ðŸ”¥ Ofertas\"\n      },\n      {\n        \"id\": \"pedido\",\n        \"label\": \"ðŸ“¦ Consultar Pedido\"\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -640,
        -3408
      ],
      "id": "5380d424-e602-4819-bb05-271b429a9591",
      "name": "Send Buttons"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2432,
        -2480
      ],
      "id": "912e4698-0d71-4afb-bcfb-21724b608464",
      "name": "Merge Audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-audio",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "audio",
              "value": "=data:{{ $('Merge Audio').item.binary.data.mimeType }};base64,{{ $('Merge Audio').item.binary.data.data }}"
            },
            {
              "name": "delayTyping",
              "value": "6"
            },
            {
              "name": "waveform",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2208,
        -2464
      ],
      "id": "a0217f9e-0c0d-42ad-a880-d337561c113c",
      "name": "Send Audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-document/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').first().json.user.sender_phone }}"
            },
            {
              "name": "document",
              "value": "https://drive.google.com/uc?export=download&id=1z1N-NqCHW2PrC1_HJS01MP6geTL6Jf_S"
            },
            {
              "name": "fileName",
              "value": "CatÃ¡logo Ed PerfumerÃ­a Hombre"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1984,
        -2464
      ],
      "id": "6316a2fd-75db-469f-9d58-a49798f5ba3a",
      "name": "Send Catalog Man"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-document/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').first().json.user.sender_phone }}"
            },
            {
              "name": "document",
              "value": "https://drive.google.com/uc?export=download&id=1sf7vcqR6USGi-b496e7kCshxMNwI-4c4"
            },
            {
              "name": "fileName",
              "value": "CatÃ¡logo Ed PerfumerÃ­a Mujer"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1760,
        -2464
      ],
      "id": "582142e1-6cc3-4017-be21-8ddd79f96d05",
      "name": "Send Catalog Women"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1UND_G3K4tu_xmjsTOSyq3ypRVpzg95HH",
          "mode": "list",
          "cachedResultName": "Buenos Dias.ogg",
          "cachedResultUrl": "https://drive.google.com/file/d/1UND_G3K4tu_xmjsTOSyq3ypRVpzg95HH/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -2656,
        -2736
      ],
      "id": "127d122e-f1eb-4bfd-8e4a-ca5f5f7b269d",
      "name": "Download Good Morning",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "lZPZd6pI3LpqZuri",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1oFABnmJkXuevND9TxwJP_zcM2VLsDPtb",
          "mode": "list",
          "cachedResultName": "Buenas Tardes.ogg",
          "cachedResultUrl": "https://drive.google.com/file/d/1oFABnmJkXuevND9TxwJP_zcM2VLsDPtb/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -2656,
        -2544
      ],
      "id": "aea851d1-2a76-4e5f-9ce4-31bdb1fedd60",
      "name": "Download Good Afternoon",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "lZPZd6pI3LpqZuri",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "16PkBRIK-Iv-VKInmhW1nq5Qfjc0EKWn2",
          "mode": "list",
          "cachedResultName": "Buenas Noches.ogg",
          "cachedResultUrl": "https://drive.google.com/file/d/16PkBRIK-Iv-VKInmhW1nq5Qfjc0EKWn2/view?usp=drivesdk"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -2656,
        -2352
      ],
      "id": "6d8f871b-d70a-4576-a97e-e23e092d5c67",
      "name": "Download  Good Night",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "lZPZd6pI3LpqZuri",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ofertas = [\n`ðŸŽ€ *Promociones especiales de Ed PerfumerÃ­a*\n\nðŸ’Ž **Ofertas disponibles:**\n1 unidad â†’ $60.000\n2 unidades â†’ $100.000  \n3 unidades â†’ $120.000\n6 unidades â†’ $210.000\n\nðŸ”¥ Â¡Fragancias increÃ­bles a precios Ãºnicos!`,\n\n`ðŸŽ *Ofertas Ed PerfumerÃ­a*\n\nâœ¨ **Precios especiales:**\n1 por $60.000\n2 por $100.000\n3 por $120.000\n6 por $210.000\n\nðŸ’« Â¡Aprovecha nuestros mejores precios!`,\n\n`ðŸ’Ž *PromociÃ³n de la semana*\n\nðŸ”¥ **Ofertas vigentes:**\n1 unidad: $60.000\n2 unidades: $100.000\n3 unidades: $120.000\n6 unidades: $210.000\n\nðŸŽ‰ Â¡No dejes pasar estas ofertas!`,\n\n`ðŸŒŸ *Ofertas especiales*\n\nðŸ’¥ **Promociones disponibles:**\n1 x $60.000 | 2 x $100.000 | 3 x $120.000 | 6 x $210.000\n\nâœ¨ Â¡Solo por tiempo limitado!`,\n\n`ðŸŽŠ *Ed PerfumerÃ­a - Ofertas*\n\nðŸŽ **Precios increÃ­bles:**\n1 fragancia â†’ $60.000\n2 fragancias â†’ $100.000\n3 fragancias â†’ $120.000\n6 fragancias â†’ $210.000\n\nðŸ”¥ Â¡Te van a encantar!`,\n\n`ðŸ’– *Promociones actuales*\n\nðŸŒ¸ **Ofertas de hoy:**\n1 unidad por $60.000\n2 unidades por $100.000\n3 unidades por $120.000\n6 unidades por $210.000\n\nðŸ’Ž Â¡Aprovecha esta oportunidad!`,\n\n`ðŸš€ *Ofertas Ed PerfumerÃ­a*\n\nâ­ **Precios especiales:**\n1 â†’ $60.000\n2 â†’ $100.000\n3 â†’ $120.000\n6 â†’ $210.000\n\nðŸŽ‰ Â¡Promociones por tiempo limitado!`,\n\n`ðŸŒˆ *PromociÃ³n especial*\n\nðŸ’« **Ofertas vigentes:**\n1 unidad: $60.000\n2 unidades: $100.000\n3 unidades: $120.000\n6 unidades: $210.000\n\nðŸ”¥ Â¡No te las pierdas!`,\n\n`ðŸŽ€ *Ofertas de la semana*\n\nâœ¨ **Precios Ãºnicos:**\n1 x $60.000 â€¢ 2 x $100.000 â€¢ 3 x $120.000 â€¢ 6 x $210.000\n\nðŸŽ Â¡Fragancias increÃ­bles a precios especiales!`,\n\n`ðŸ’ *Ed PerfumerÃ­a - Promociones*\n\nðŸŒŸ **Ofertas disponibles:**\n1 unidad = $60.000\n2 unidades = $100.000\n3 unidades = $120.000\n6 unidades = $210.000\n\nðŸ’Ž Â¡Aprovecha nuestras mejores ofertas!`\n];\n\n// Selecciona uno al azar\nconst ofertaAleatoria = ofertas[Math.floor(Math.random() * ofertas.length)];\nreturn [\n  {\n    json: {\n      output: ofertaAleatoria\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3104,
        -2160
      ],
      "id": "4e401dc9-b919-412e-ac80-b3f48511948c",
      "name": "Dynamic Offers"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.output.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2880,
        -2160
      ],
      "id": "b0184ab5-3dcc-4b73-a26a-6de0611b3850",
      "name": "Send Dynamic Offers"
    },
    {
      "parameters": {
        "jsCode": "const comprar = [\n  `ðŸŒŸ Â¡INCREÃBLE! Â¡EstÃ¡s a punto de descubrir tu aroma ideal!\n\n- ðŸ” Â¡BÃºscala! Encuentra esa fragancia que tienes en mente  \n- ðŸ’¡ Â¡SorprÃ©ndeme! DÃ©jame recomendarte algo Ãºnico  \n- âš–ï¸ Â¡CompÃ¡ralas! Descubre cuÃ¡l se adapta mejor a ti  \n- ðŸ›’ Â¡CÃ³mprala ya! Hazla tuya y disfruta su esencia  \n\nâœ¨ Â¿QuÃ© deseas hacer? Â¡CuÃ©ntanos quÃ© te gusta!`,\n\n  `ðŸ’¥ Â¡WOW! Â¡La aventura aromÃ¡tica comienza ahora!\n\n- ðŸ” Â¡Explora! Busca esa lociÃ³n que te inspira  \n- ðŸ’¡ Â¡InspÃ­rame! RecomiÃ©ndame algo fabuloso  \n- âš–ï¸ Â¡CompÃ¡ralas! Elige entre las mejores opciones  \n- ðŸ›’ Â¡Hazla tuya! Compra tu favorita y dÃ©jate sorprender  \n\nðŸŒˆ Â¿QuÃ© prefieres? Â¡Dinos quÃ© te emociona!`,\n\n  `ðŸŽ‰ Â¡FANTÃSTICO! Â¡EstÃ¡s a un paso de tu fragancia soÃ±ada!\n\n- ðŸ” Â¡DescÃºbrela! Encuentra ese aroma especial  \n- ðŸ’¡ Â¡RecomiÃ©ndame! SorprÃ©ndeme con algo nuevo  \n- âš–ï¸ Â¡CompÃ¡ralas! Veamos juntas/os las mejores alternativas  \n- ðŸ›’ Â¡CÃ³mprala ya! LlÃ©vala contigo y siÃ©ntela cada dÃ­a  \n\nâœ¨ Â¿QuÃ© te gustarÃ­a hacer? Â¡CuÃ©ntame tu preferencia!`,\n\n  `ðŸ’Ž Â¡ESPECTACULAR! Â¡Vamos a encontrar tu fragancia perfecta!\n\n- ðŸ” Â¡BÃºscala! Esa lociÃ³n que no puedes olvidar  \n- ðŸ’¡ Â¡SorprÃ©ndeme! RecomiÃ©ndame algo que me encante  \n- âš–ï¸ Â¡CompÃ¡ralas! Descubre cuÃ¡l es la ideal para ti  \n- ðŸ›’ Â¡CÃ³mprala ya! Hazla parte de tu dÃ­a a dÃ­a  \n\nðŸš€ Â¿QuÃ© opciÃ³n te llama mÃ¡s la atenciÃ³n? Â¡Dinos quÃ© te gusta!`,\n\n  `ðŸŽŠ Â¡SENSACIONAL! Â¡Tu fragancia ideal estÃ¡ a un paso!\n\n- ðŸ” Â¡EncuÃ©ntrala! Busca ese aroma que te fascina  \n- ðŸ’¡ Â¡DÃ©jate sorprender! Te recomiendo algo especial  \n- âš–ï¸ Â¡CompÃ¡ralas! Analicemos juntas/os las mejores opciones  \n- ðŸ›’ Â¡CÃ³mprala ya! Hazla tuya y disfruta su magia  \n\nâœ¨ Â¿QuÃ© deseas hacer? Â¡CuÃ©ntanos tu gusto!`,\n\n  `ðŸ”¥ Â¡EMOCIONANTE! Â¡Elige cÃ³mo quieres descubrir tu prÃ³xima fragancia!\n\n- ðŸ” Â¡BÃºscala! Encuentra tu aroma favorito  \n- ðŸ’¡ Â¡SorprÃ©ndeme! RecomiÃ©ndame algo diferente  \n- âš–ï¸ Â¡CompÃ¡ralas! Veamos cuÃ¡l es la mejor para ti  \n- ðŸ›’ Â¡CÃ³mprala ya! LlÃ©vala contigo y siÃ©ntela siempre  \n\nðŸŒŸ Â¿QuÃ© prefieres? Â¡Dinos quÃ© te gustarÃ­a probar!`,\n\n  `ðŸŒˆ Â¡MARAVILLOSO! Â¡EstÃ¡s a punto de encontrar tu esencia perfecta!\n\n- ðŸ” Â¡DescÃºbrela! Busca esa fragancia especial  \n- ðŸ’¡ Â¡RecomiÃ©ndame! DÃ©jame sorprenderte con algo nuevo  \n- âš–ï¸ Â¡CompÃ¡ralas! Elige entre las mejores alternativas  \n- ðŸ›’ Â¡CÃ³mprala ya! Hazla tuya y disfruta cada momento  \n\nâœ¨ Â¿QuÃ© te gustarÃ­a hacer? Â¡CuÃ©ntame quÃ© buscas!`,\n\n  `ðŸš€ Â¡EXTRAORDINARIO! Â¡Vamos a por tu fragancia soÃ±ada!\n\n- ðŸ” Â¡BÃºscala! Encuentra ese aroma que te inspira  \n- ðŸ’¡ Â¡SorprÃ©ndeme! RecomiÃ©ndame algo que me enamore  \n- âš–ï¸ Â¡CompÃ¡ralas! Descubre cuÃ¡l es la mejor opciÃ³n  \n- ðŸ›’ Â¡CÃ³mprala ya! Hazla parte de tu rutina  \n\nðŸ’« Â¿QuÃ© deseas hacer? Â¡Dinos tu preferencia!`,\n\n  `ðŸŽ Â¡FELICIDAD! Â¡Tu prÃ³xima fragancia te estÃ¡ esperando!\n\n- ðŸ” Â¡EncuÃ©ntrala! Busca esa lociÃ³n especial  \n- ðŸ’¡ Â¡DÃ©jate sorprender! Te recomiendo algo increÃ­ble  \n- âš–ï¸ Â¡CompÃ¡ralas! Analicemos juntas/os las mejores opciones  \n- ðŸ›’ Â¡CÃ³mprala ya! Hazla tuya y disfruta su aroma  \n\nâœ¨ Â¿QuÃ© prefieres? Â¡CuÃ©ntanos quÃ© te gustarÃ­a!`,\n\n  `ðŸ’– Â¡DIVERTIDO! Â¡Elige cÃ³mo quieres descubrir tu nuevo aroma!\n\n- ðŸ” Â¡BÃºscala! Encuentra tu fragancia soÃ±ada  \n- ðŸ’¡ Â¡SorprÃ©ndeme! RecomiÃ©ndame algo que me encante  \n- âš–ï¸ Â¡CompÃ¡ralas! Descubre cuÃ¡l es la ideal para ti  \n- ðŸ›’ Â¡CÃ³mprala ya! Hazla parte de tu dÃ­a a dÃ­a  \n\nðŸŒŸ Â¿QuÃ© deseas hacer? Â¡Dinos quÃ© te gusta y te ayudo enseguida!`\n];\n\n// Selecciona uno al azar\nconst comprarAleatorio = comprar[Math.floor(Math.random() * comprar.length)];\nreturn [\n  {\n    json: {\n      output: comprarAleatorio\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3104,
        -1968
      ],
      "id": "bd8acf05-4639-4516-8833-02e4fc55efc7",
      "name": "Dynamic Buy"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ Math.floor((parseInt($json.output.length) * 25) / 1000) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2880,
        -1968
      ],
      "id": "0d00c49e-f5d4-414f-aec8-bb3feeeaf8ed",
      "name": "Send Dynamic Buy"
    },
    {
      "parameters": {
        "jsCode": "const consultarPedido = [\n`ðŸ“¦ *Â¡Perfecto! Consultemos tu pedido*\n\nÂ¿QuÃ© necesitas saber sobre tu compra?\n- Â¿Estado del envÃ­o?\n- Â¿NÃºmero de guÃ­a?\n- Â¿Tiempo de entrega?\n\nðŸšš Â¡Estamos aquÃ­ para ayudarte!`,\n\n`ðŸ” *Â¡Excelente! Revisemos tu orden*\n\nÂ¿Sobre quÃ© quieres consultar?\n- Â¿DÃ³nde estÃ¡ mi pedido?\n- Â¿CuÃ¡ndo llega?\n- Â¿Datos de envÃ­o?\n\nðŸ“‹ Â¡Dinos quÃ© necesitas saber!`,\n\n`ðŸ“± *Â¡Genial! Veamos tu pedido*\n\nÂ¿QuÃ© informaciÃ³n necesitas?\n- Â¿Estado actual del envÃ­o?\n- Â¿NÃºmero de seguimiento?\n- Â¿Fecha estimada de entrega?\n\nâœ¨ Â¡Consultemos juntos!`,\n\n`ðŸš› *Â¡Listo para ayudarte!*\n\nÂ¿QuÃ© quieres saber de tu compra?\n- Â¿EstÃ¡ en camino?\n- Â¿Tienes la guÃ­a?\n- Â¿AlgÃºn problema?\n\nðŸŒŸ Â¡Revisemos tu pedido!`,\n\n`ðŸ“¦ *Â¡Vamos a consultar tu envÃ­o!*\n\nÂ¿Sobre quÃ© necesitas informaciÃ³n?\n- Â¿Estado del pedido?\n- Â¿Seguimiento de envÃ­o?\n- Â¿Tiempo de llegada?\n\nðŸ’Ž Â¡Estamos para resolver tus dudas!`,\n\n`ðŸ”Ž *Â¡Perfecto! Consultemos tu orden*\n\nÂ¿QuÃ© informaciÃ³n buscas?\n- Â¿DÃ³nde estÃ¡ mi compra?\n- Â¿NÃºmero de guÃ­a?\n- Â¿CuÃ¡ndo llega?\n\nðŸŽ‰ Â¡Revisemos juntos!`,\n\n`ðŸ“‹ *Â¡Excelente! Veamos tu pedido*\n\nÂ¿QuÃ© necesitas consultar?\n- Â¿Estado de envÃ­o?\n- Â¿Datos de seguimiento?\n- Â¿InformaciÃ³n de entrega?\n\nðŸ”¥ Â¡Dinos quÃ© quieres saber!`,\n\n`ðŸšš *Â¡Consultemos tu compra!*\n\nÂ¿Sobre quÃ© tienes dudas?\n- Â¿Mi pedido ya saliÃ³?\n- Â¿CuÃ¡l es mi guÃ­a?\n- Â¿CuÃ¡ndo llega?\n\nðŸŒˆ Â¡Estamos para ayudarte!`,\n\n`ðŸ“± *Â¡Genial! Revisemos tu envÃ­o*\n\nÂ¿QuÃ© informaciÃ³n necesitas?\n- Â¿Estado actual?\n- Â¿NÃºmero de seguimiento?\n- Â¿Fecha de entrega?\n\nðŸ’« Â¡Consultemos tu pedido!`,\n\n`ðŸ” *Â¡Perfecto! Veamos tu orden*\n\nÂ¿QuÃ© quieres saber?\n- Â¿DÃ³nde estÃ¡ mi pedido?\n- Â¿GuÃ­a de envÃ­o?\n- Â¿Tiempo estimado?\n\nðŸŽ Â¡Resolvamos tus dudas!`\n];\n\n// Selecciona uno al azar\nconst consultarPedidoAleatorio = consultarPedido[Math.floor(Math.random() * consultarPedido.length)];\nreturn [\n  {\n    json: {\n      output: consultarPedidoAleatorio\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3104,
        -1776
      ],
      "id": "87969b66-7097-4ffd-a929-4c17d3d8e5f0",
      "name": "Dynamic Order"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ Math.floor((parseInt($json.output.length) * 25) / 1000) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2880,
        -1776
      ],
      "id": "d42e94bb-00b2-4862-ad4d-db01927a340b",
      "name": "Send Dynamic Order"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_principal_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'SALUDO');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -416,
        -3408
      ],
      "id": "e802a742-f051-49cb-bb76-0ff58d928d5e",
      "name": "Execute Status Greeting",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_principal_pro('{{ $('WhatsApp Message Parser').first().json.user.sender_phone }}', 'CATALOGO');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1536,
        -2464
      ],
      "id": "0f491f5c-5aca-4d10-bd63-413eedfed564",
      "name": "Execute Status Catalog",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_principal_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'OFERTAS');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2656,
        -2160
      ],
      "id": "69e0e066-b2c8-44c8-805a-a86c910ab31d",
      "name": "Execute Status Offers",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_principal_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'VENTAS');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2656,
        -1968
      ],
      "id": "f8af3137-a492-45d6-90f6-76b0181a4181",
      "name": "Execute Status Buy",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_principal_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'SOPORTE');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2656,
        -1776
      ],
      "id": "c4d40204-07af-49d7-9f5d-739139e36955",
      "name": "Execute Status Order",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.estado }}",
                    "rightValue": "VENTAS",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ventas-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "sales"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.estado }}",
                    "rightValue": "SOPORTE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "soporte-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "order"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -864,
        -2976
      ],
      "id": "8c49aba9-4275-40ce-affd-1a8988d8309e",
      "name": "Status Response IA"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -640,
        -2832
      ],
      "id": "14691d4b-64a3-47dc-99b8-a967c7a86164",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "inputText": "={{ $('Format Final Output').item.json.conversation_content }}",
        "categories": {
          "categories": [
            {
              "category": "COMPRA_DIRECTA",
              "description": "Cliente manifiesta voluntad definitiva de adquirir productos especÃ­ficos, solicita procesos de venta, cotizaciones totales, o confirma decisiones de compra. Incluye expresiones de compra inmediata, solicitudes de cÃ¡lculo de totales, procesos de pago, datos de contacto para ventas, y confirmaciones directas."
            },
            {
              "category": "CONSULTA_INVENTARIO",
              "description": "Cliente busca informaciÃ³n especÃ­fica sobre productos individuales sin expresar intenciÃ³n de compra ni solicitar ayuda para elegir. Incluye consultas sobre precios unitarios, disponibilidad de stock, caracterÃ­sticas tÃ©cnicas, especificaciones del producto, contenido, originalidad, y verificaciÃ³n de existencias."
            },
            {
              "category": "SOLICITUD_RECOMENDACION",
              "description": "Cliente busca consejo personalizado, sugerencias adaptadas a sus necesidades, ayuda para tomar decisiones de compra, o recomendaciones basadas en ocasiones, gustos, presupuesto o preferencias especÃ­ficas. El cliente delega la decisiÃ³n al vendedor o busca orientaciÃ³n experta."
            },
            {
              "category": "COMPARACION_PRODUCTOS",
              "description": "Cliente solicita anÃ¡lisis objetivo de diferencias, similitudes, ventajas y desventajas entre productos especÃ­ficos ya identificados. Busca informaciÃ³n comparativa tÃ©cnica sin necesariamente pedir ayuda para decidir, sino datos para evaluar opciones por sÃ­ mismo."
            }
          ]
        },
        "options": {
          "systemPromptTemplate": "<rol>\nActÃºa como un experto clasificador de intenciones de compra con 10+ aÃ±os de experiencia en anÃ¡lisis de comportamiento del consumidor en e-commerce.\n</rol>\n\n<tarea>\nClasifica con mÃ¡xima precisiÃ³n la intenciÃ³n de compra del cliente basÃ¡ndote Ãºnicamente en el texto proporcionado, enfocÃ¡ndote en el customer journey de ventas.\n</tarea>\n\n<instrucciones>\nPiensa paso a paso:\n\n1. **Identifica el verbo principal** y el tipo de pregunta (Â¿quÃ© busca realmente?)\n2. **Analiza las palabras clave** que indican nivel de intenciÃ³n de compra\n3. **EvalÃºa si ya decidiÃ³ comprar** vs. necesita informaciÃ³n vs. busca ayuda vs. compara\n4. **Considera el contexto completo** del mensaje, incluyendo lenguaje informal\n5. **Clasifica en UNA sola categorÃ­a** - la intenciÃ³n MÃS dominante\n6. **Responde ÃšNICAMENTE con el nombre de la categorÃ­a**\n</instrucciones>\n\n<categorias>\n**COMPRA_DIRECTA**: Cliente manifiesta voluntad definitiva de adquirir productos especÃ­ficos, solicita procesos de venta, cotizaciones totales, o confirma decisiones de compra. \n*SeÃ±ales clave: \"quiero comprar\", \"me llevo\", \"cuÃ¡nto cuesta todo\", \"proceder al pago\", \"cotizaciÃ³n completa\", \"ya decidÃ­\", \"voy a comprar\"*\n\n**CONSULTA_INVENTARIO**: Cliente busca informaciÃ³n especÃ­fica sobre productos individuales: disponibilidad, precios, caracterÃ­sticas, especificaciones. NO expresa intenciÃ³n de compra ni solicita ayuda para elegir.\n*SeÃ±ales clave: \"tienes\", \"tenÃ©s\", \"tenes\", \"hay\", \"estÃ¡\", \"queda\", \"manejas\", \"vendes\", \"vendÃ©s\", \"trabajas\", \"traes\", \"trajiste\", \"te llegÃ³\", \"conseguÃ­s\", \"me consigues\", \"me das\", \"me vendÃ©s\", \"me vendes\", \"ofrecÃ©s\", \"ofreces\", \"se puede\", \"puedo conseguir\", \"comprarte\", \"precio de\", \"cuÃ¡nto vale\", \"cuÃ¡nto cuesta\", \"cuÃ¡nto estÃ¡\", \"cuÃ¡nto sale\", \"a como\", \"a cuÃ¡nto\", \"estÃ¡ disponible\", \"disponible\", \"en stock\", \"stock\", \"especificaciones\", \"caracterÃ­sticas\"*\n\n**SOLICITUD_RECOMENDACION**: Cliente busca consejo personalizado, sugerencias adaptadas a sus necesidades, ayuda para tomar decisiones de compra, o recomendaciones basadas en ocasiones, gustos, presupuesto o preferencias.\n*SeÃ±ales clave: \"quÃ© me recomiendas\", \"cuÃ¡l es mejor para\", \"ayÃºdame a elegir\", \"necesito algo\", \"quÃ© me conviene\", \"busco\", \"quiero algo que\", \"para regalo\"*\n\n**COMPARACION_PRODUCTOS**: Cliente solicita anÃ¡lisis objetivo de diferencias, similitudes, ventajas y desventajas entre productos especÃ­ficos ya identificados.\n*SeÃ±ales clave: \"vs\", \"comparar\", \"diferencias entre\", \"cuÃ¡l es mejor entre\", \"pros y contras\", \"ventajas de X sobre Y\", \"quÃ© es mejor\"*\n</categorias>\n\n<ejemplos>\nInput: \"Quiero comprar 2 frascos de Love Spell y 1 lociÃ³n Victoria's Secret, Â¿cuÃ¡nto me sale todo con envÃ­o?\"\nOutput: COMPRA_DIRECTA\n\nInput: \"Â¿CuÃ¡nto cuesta el perfume Chanel Coco Mademoiselle de 100ml?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Tienes la one million\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Â¿Hay disponible el perfume Dior Sauvage?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Â¿Manejas perfumes de hombre?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Me consigues el Chanel No. 5\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Trabajas con perfumes importados\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Â¿Te llegÃ³ la lociÃ³n Victoria Secret?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Queda stock del Dior Sauvage\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Â¿CuÃ¡nto estÃ¡ el perfume Carolina Herrera?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Â¿Se puede conseguir el One Million Lucky?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Necesito un perfume dulce y juvenil para una chica de 20 aÃ±os, Â¿quÃ© me recomiendas?\"\nOutput: SOLICITUD_RECOMENDACION\n\nInput: \"Â¿CuÃ¡les son las diferencias entre la lociÃ³n corporal y el perfume de la misma fragancia?\"\nOutput: COMPARACION_PRODUCTOS\n\nInput: \"Me llevo el set de perfume + lociÃ³n corporal, Â¿cÃ³mo procedo al pago?\"\nOutput: COMPRA_DIRECTA\n\nInput: \"Â¿Tienen disponible la lociÃ³n Victoria's Secret Bombshell en presentaciÃ³n de 250ml?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Busco una fragancia elegante para regalo de aniversario, presupuesto $200\"\nOutput: SOLICITUD_RECOMENDACION\n\nInput: \"Perfume Dior Sauvage vs lociÃ³n corporal Sauvage, Â¿cuÃ¡l dura mÃ¡s?\"\nOutput: COMPARACION_PRODUCTOS\n\nInput: \"Â¿Vendes el perfume Carolina Herrera Good Girl?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Hay algÃºn descuento en perfumes importados\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Â¿TenÃ©s la lociÃ³n corporal Bombshell?\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"Me das precio del Dior Homme\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"A cuanto el One Million Prive\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"A como estÃ¡ el perfume Dior\"\nOutput: CONSULTA_INVENTARIO\n\nInput: \"A como me lo dejas\"\nOutput: CONSULTA_INVENTARIO\n</ejemplos>\n\n<reglas_de_clasificacion>\n**PRIORIDADES en caso de ambigÃ¼edad:**\n1. Si menciona compra directa + otra cosa â†’ COMPRA_DIRECTA\n2. Si compara productos especÃ­ficos â†’ COMPARACION_PRODUCTOS  \n3. Si busca consejo/ayuda para elegir â†’ SOLICITUD_RECOMENDACION\n4. Si solo pregunta info tÃ©cnica/precio/disponibilidad â†’ CONSULTA_INVENTARIO\n\n**CASOS ESPECIALES:**\n- \"Â¿CuÃ¡l cuesta menos entre X y Y?\" â†’ COMPARACION_PRODUCTOS (no consulta de inventario)\n- \"Quiero algo bueno y barato\" â†’ SOLICITUD_RECOMENDACION (no compra directa)\n- \"Â¿Tienes el perfume Dior en presentaciÃ³n de 30ml?\" â†’ CONSULTA_INVENTARIO (variante especÃ­fica)\n- \"Me interesa esta lociÃ³n\" â†’ CONSULTA_INVENTARIO (interÃ©s â‰  compra directa)\n- \"Â¿QuÃ© tal huele el perfume X?\" â†’ CONSULTA_INVENTARIO (caracterÃ­sticas del producto)\n- \"Â¿La lociÃ³n corporal huele igual que el perfume?\" â†’ COMPARACION_PRODUCTOS (comparando formatos)\n- \"Busco algo para seducir\" â†’ SOLICITUD_RECOMENDACION (necesidad especÃ­fica)\n- \"Tienes la [nombre del perfume]\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n- \"Â¿Hay [producto]?\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n- \"Â¿Manejas [tipo de producto]?\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n- \"Me consigues [producto]\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n- \"Â¿Te llegÃ³ [producto]?\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n- \"Queda stock de [producto]\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n- \"Â¿CuÃ¡nto estÃ¡ [producto]?\" â†’ CONSULTA_INVENTARIO (pregunta de precio)\n- \"A como [producto]\" â†’ CONSULTA_INVENTARIO (pregunta de precio)\n- \"A cuÃ¡nto [producto]\" â†’ CONSULTA_INVENTARIO (pregunta de precio)\n- \"Trabajas con [categorÃ­a]\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n- \"Â¿Se puede conseguir [producto]?\" â†’ CONSULTA_INVENTARIO (pregunta de disponibilidad)\n\n**VARIACIONES DE LENGUAJE INFORMAL Y MODERNO:**\n- **Disponibilidad**: \"Tienes\" = \"TenÃ©s\" = \"Tenes\" = \"Hay\" = \"EstÃ¡\" = \"Queda\" = \"Stock\"\n- **Venta/Manejo**: \"Manejas\" = \"Vendes\" = \"VendÃ©s\" = \"Trabajas\" = \"Traes\" = \"OfrecÃ©s\" = \"Ofreces\"\n- **Conseguir**: \"Me consigues\" = \"ConseguÃ­s\" = \"Se puede conseguir\" = \"Puedo conseguir\"\n- **Llegada/Stock**: \"Te llegÃ³\" = \"Trajiste\" = \"Llegaste a traer\"\n- **Precio informal**: \"CuÃ¡nto estÃ¡\" = \"CuÃ¡nto sale\" = \"A cuÃ¡nto\" = \"A como\" = \"CuÃ¡nto vale\"\n- **Compra indirecta**: \"Me das\" = \"Me vendÃ©s\" = \"Me vendes\" = \"Comprarte\"\n- **Sin signos de interrogaciÃ³n**: \"Tienes el perfume\" = \"Â¿Tienes el perfume?\"\n- **Sin artÃ­culos**: \"Tienes one million\" = \"Tienes la one million\"\n\n**TODAS estas variaciones son CONSULTA_INVENTARIO cuando preguntan por productos especÃ­ficos**\n</reglas_de_clasificacion>\n\n<restricciones>\n- NO expliques tu razonamiento\n- RESPONDE Ãºnicamente con el nombre de la categorÃ­a\n- SÃ© preciso y consistente en la clasificaciÃ³n\n- Considera variaciones de lenguaje informal y coloquial\n</restricciones>"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.textClassifier",
      "typeVersion": 1.1,
      "position": [
        -192,
        -2576
      ],
      "id": "61ce00b2-c551-485b-8665-5e486180f048",
      "name": "Text Classifier"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -96,
        -2288
      ],
      "id": "4d473592-2e17-446d-958b-014bb64b11bb",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "4I5hY4XwoALE8VJS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "4HlRidEr8jDW0Zan",
          "mode": "list",
          "cachedResultName": "My Sub Product Comparator Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        208,
        -2288
      ],
      "id": "e8537d82-0ae5-46b8-8cb7-f29519d06d0e",
      "name": "COMPARACION"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "8xMoAwEO7wUKJTXi",
          "mode": "list",
          "cachedResultName": "My Sub Recommendation Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        208,
        -2480
      ],
      "id": "caffca02-fd14-4535-beac-eab43ab03512",
      "name": "RECOMENDACION"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "Tk1Yk7Bhqs7KvV9o",
          "mode": "list",
          "cachedResultName": "My Sub Sales Specialist Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        208,
        -2976
      ],
      "id": "06726e3a-86de-48ed-8001-7191d815e3f5",
      "name": "COMPRA"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "l0HpKncxwOEcFy8h",
          "mode": "list",
          "cachedResultName": "My Sub Inventory Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $('Format Final Output').item.json.conversation_content }}",
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "Query",
              "required": true,
              "type": "string",
              "description": "The user query to process"
            },
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        208,
        -2672
      ],
      "id": "55d8eb08-97b0-4da0-a84a-54b7b2b46bc2",
      "name": "INVENTARIO"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "df7a03b3-03fc-4afa-a80a-c622687316f2",
              "leftValue": "={{ $json.estado_ventas }}",
              "rightValue": "=ESPERANDO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "27a3251e-1e79-4459-ae35-dcbc2570064d",
              "leftValue": "={{ $json.estado_ventas }}",
              "rightValue": "LISTO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "407ed461-7e17-4638-a2bf-7da0f1fc9d25",
              "leftValue": "={{ $json.estado_ventas }}",
              "rightValue": "FIN",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -416,
        -2720
      ],
      "id": "7d6d46a6-ea63-49e1-9b47-3bce209463ac",
      "name": "If1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "ROJE11JYihvwJXvW",
          "mode": "list",
          "cachedResultName": "My Sub Contra Entrega"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "sessionId",
              "displayName": "Session ID",
              "required": true,
              "type": "string",
              "description": "Session identifier for chat memory (sender phone number)"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -3104,
        -1584
      ],
      "id": "8abb89d1-0864-486a-8a9f-fcc920b12429",
      "name": "Contra_Entrega"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.estado_ventas }}",
                    "rightValue": "RECOLECTANDO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3e6fe2c2-595d-430e-8c1a-84645d16f022"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RECOLECTANDO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "97d8f253-f9a1-44a3-a541-c674b5d11535",
                    "leftValue": "={{ $json.estado_ventas }}",
                    "rightValue": "ESPERANDO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ESPERANDO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "04ef01b1-f32f-49ce-9e76-1fb09e162083",
                    "leftValue": "={{ $json.estado_ventas }}",
                    "rightValue": "LISTO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "LISTO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d96bfc64-af1e-4304-88c2-d148d7ce8798",
                    "leftValue": "={{ $json.estado_ventas }}",
                    "rightValue": "COTIZANDO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "COTIZANDO"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -640,
        -3120
      ],
      "id": "58e27a2e-ade0-4287-983e-105a326fd926",
      "name": "Switch"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "WVmEpKVLhRNt0mTP",
          "mode": "list",
          "cachedResultName": "My Sub-Validator-Data"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "sessionId": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}",
            "message": "={{ $('Format Final Output').item.json.conversation_content }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -416,
        -3216
      ],
      "id": "08668745-c9aa-4aa3-b270-ff12c0950aaa",
      "name": "VALIDATOR DATA"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('573011284297');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1088,
        -2960
      ],
      "id": "5d214dc4-f9ce-4a76-b63e-68a3a4c5c70f",
      "name": "Get Data User",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        -1200
      ],
      "id": "96416135-8939-423f-b3de-88a9c3cc9a51",
      "name": "Get Data User1",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Script para generar SOLO mensajes variados de modificaciÃ³n de pedido (SIN BOTONES)\n// Obtener los datos de entrada\nconst datosCliente = $input.first().json;\nconst productosInfo = datosCliente.productos_info;\n\n// CORRECCIÃ“N: Calcular el total correcto basado en los productos\nconst totalProductoCorregido = productosInfo.reduce((sum, producto) => sum + producto.total, 0);\nconst cantidadTotalCorregida = productosInfo.reduce((sum, producto) => sum + producto.cantidad, 0);\n\n// FunciÃ³n para formatear el total con separadores de miles\nfunction formatearPrecio(precio) {\n  return new Intl.NumberFormat('es-CO', {\n    style: 'currency',\n    currency: 'COP',\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 0\n  }).format(precio).replace('COP', '').trim();\n}\n\n// Crear el resumen del pedido actual\nfunction crearResumenPedido() {\n  if (productosInfo.length === 1) {\n    const producto = productosInfo[0];\n    return `${producto.nombre} x ${producto.cantidad} unidades (${formatearPrecio(producto.total)})`;\n  } else {\n    const totalItems = cantidadTotalCorregida; // Usar el valor corregido\n    const listaProductos = productosInfo.map(p => `${p.nombre} x${p.cantidad}`).join(', ');\n    return `${totalItems} productos: ${listaProductos} (${formatearPrecio(totalProductoCorregido)})`;\n  }\n}\n\n// Crear lista detallada de productos para mostrar\nfunction crearListaDetallada() {\n  if (productosInfo.length === 1) {\n    const producto = productosInfo[0];\n    return `ðŸ§´ *${producto.nombre}* â†’ ${producto.cantidad} uni`;\n  } else {\n    return productosInfo.map(p => `ðŸ§´ *${p.nombre}* â†’ ${p.cantidad} uni`).join('\\n');\n  }\n}\n\nconst resumenPedido = crearResumenPedido();\nconst listaDetallada = crearListaDetallada();\n\n// Array de 10 mensajes variados SIN BOTONES\nconst mensajes = [\n  // Mensaje 1 - Tranquilizador\n  `ðŸ˜Š *Â¡NO TE PREOCUPES!*\n\nPedido actual:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nCambiar de opiniÃ³n es totalmente normal. Estoy aquÃ­ para ayudarte a encontrar exactamente lo que necesitas.\n\nÂ¡Hazme saber quÃ© quieres modificar! ðŸ’ª`,\n\n  // Mensaje 2 - EmpÃ¡tico\n  `âœ¨ *Â¡PERFECTO TIMING!*\n\nTu pedido:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nMe encanta que te tomes el tiempo para asegurarte de que todo estÃ© como lo deseas. Queremos que quedes 100% satisfecho.\n\nEstoy aquÃ­ para ayudarte â¤ï¸`,\n\n  // Mensaje 3 - Motivador\n  `ðŸŒŸ *Â¡EXCELENTE DECISIÃ“N!*\n\nPedido actual:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nTomarte el tiempo para revisar y ajustar muestra que realmente te importa hacer la mejor elecciÃ³n. Â¡Eso me gusta!\n\nÂ¡Vamos a dejarlo perfecto! ðŸŽ¯`,\n\n  // Mensaje 4 - Cercano\n  `ðŸ¤ *Â¡ESTOY CONTIGO!*\n\nTienes:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nNo hay problema alguno en querer ajustar tu pedido. Mi trabajo es que tengas exactamente lo que buscas.\n\nÂ¡CuÃ©ntame quÃ© necesitas cambiar! ðŸ˜Š`,\n\n  // Mensaje 5 - Directo y amigable\n  `âœï¸ *Â¿QUÃ‰ QUIERES MODIFICAR?*\n\nPedido actual:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nEscrÃ­beme quÃ© necesitas modificar y te ayudo inmediatamente ðŸ‘`,\n\n  // Mensaje 6 - Personalizado\n  `ðŸ› ï¸ *Â¿QUÃ‰ DESEAS AJUSTAR?*\n\nTu pedido:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nDime quÃ© cambio necesitas y lo actualizamos al instante âš¡`,\n\n  // Mensaje 7 - Profesional con toque personal\n  `ðŸ”§ *PERSONALIZA TU PEDIDO*\n\nSelecciÃ³n actual:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nÂ¡EscrÃ­beme tu modificaciÃ³n! ðŸš€`,\n\n  // Mensaje 8 - Sencillo y efectivo\n  `âš™ï¸ *EDITAR PEDIDO*\n\nTienes:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nÂ¿CuÃ¡l opciÃ³n necesitas? Te ayudo ya mismo ðŸ˜Š`,\n\n  // Mensaje 9 - Entusiasta\n  `âœ¨ *VAMOS A MODIFICAR*\n\nPedido:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nCuÃ©ntame quÃ© necesitas cambiar ðŸ’ª`,\n\n  // Mensaje 10 - Comprensivo y servicial\n  `ðŸŽ¨ *Â¡HAGAMOS AJUSTES!*\n\nPedido actual:\n${listaDetallada}\nTotal: ${formatearPrecio(totalProductoCorregido)}\n\nEntiendo que quieras que todo sea perfecto. Estoy aquÃ­ para hacer los cambios que necesites.\n\nÂ¡Solo dÃ­melo y lo resolvemos! ðŸŒŸ`\n];\n\n// FunciÃ³n para escapar caracteres especiales en JSON\nfunction escaparJSON(texto) {\n  return texto\n    .replace(/\\\\/g, '\\\\\\\\')  // Escapar backslashes\n    .replace(/\"/g, '\\\\\"')    // Escapar comillas dobles\n    .replace(/\\n/g, '\\\\n')   // Escapar saltos de lÃ­nea\n    .replace(/\\r/g, '\\\\r')   // Escapar retorno de carro\n    .replace(/\\t/g, '\\\\t');  // Escapar tabulaciones\n}\n\n// Seleccionar un mensaje aleatorio\nconst mensajeAleatorio = mensajes[Math.floor(Math.random() * mensajes.length)];\n\n// Retornar el resultado con valores corregidos\nreturn {\n  json: {\n    mensaje_modificacion: escaparJSON(mensajeAleatorio),\n    mensaje_sin_escapar: mensajeAleatorio, // Por si lo necesitas sin escapar\n    pedido_actual: resumenPedido,\n    total_formateado: `${formatearPrecio(totalProductoCorregido)}`,\n    cantidad_productos: productosInfo.length,\n    cantidad_total: cantidadTotalCorregida, // Valor corregido\n    total_producto: totalProductoCorregido, // Valor corregido\n    // InformaciÃ³n de depuraciÃ³n\n    debug_info: {\n      total_original: datosCliente.total_producto,\n      total_corregido: totalProductoCorregido,\n      cantidad_original: datosCliente.cantidad_total,\n      cantidad_corregida: cantidadTotalCorregida,\n      diferencia_total: totalProductoCorregido - datosCliente.total_producto,\n      diferencia_cantidad: cantidadTotalCorregida - datosCliente.cantidad_total\n    },\n    status: \"MODIFICANDO\"\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2880,
        -1200
      ],
      "id": "7df40523-806b-44b9-bdc1-28afcc24a468",
      "name": "Code"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}\",\n  \"message\": \"{{ $json.mensaje_modificacion }}\",\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"buttons\": [\n      {\n        \"id\": \"cambiar_cantidad\",\n        \"label\": \"ðŸ”¢ Cantidad de productos\"\n      },\n      {\n        \"id\": \"cambiar_producto\", \n        \"label\": \"ðŸ›ï¸ Cambiar productos\"\n      },\n      {\n        \"id\": \"quitar_producto\",\n        \"label\": \"âž– Quitar un producto\"\n      },\n      {\n        \"id\": \"modificar_todo\",\n        \"label\": \"ðŸ—‘ï¸ Vaciar carrito\"\n      },\n      {\n        \"id\": \"agregar_productos\",\n        \"label\": \"âž• Agregar mÃ¡s productos\"\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2656,
        -1200
      ],
      "id": "dccee366-9866-4436-9bb1-27bf559d1334",
      "name": "Send Buttons1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "cambiar_cantidad",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9949dc02-c7e4-4e28-b2b6-9d3cca9419e1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cambiar_cantidad"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "309bcb37-161a-490f-9328-7dceabb6c65f",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "cambiar_producto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cambiar_producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45f3d70b-4d79-4a74-aea4-228c77750f9a",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "modificar_todo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "modificar_todo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2a4c04a6-8bfe-421e-900e-1b37ce53b82c",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "agregar_productos",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agregar_productos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "73c03b41-ebc2-4dd3-a58a-d839de6a325c",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "quitar_producto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "quitar_producto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3328,
        -672
      ],
      "id": "fb13cd6c-1927-451d-84da-527e792f8b20",
      "name": "Edit Product"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        -1008
      ],
      "id": "6cc89884-4f71-41c1-a02d-9281ec18cf5a",
      "name": "Get Data cambiar_cantidad",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        -816
      ],
      "id": "63e84144-1a75-4084-a232-e621ad29e734",
      "name": "Get Data cambiar_producto",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Script para generar mensaje dinÃ¡mico de ayuda - CAMBIAR TIPO DE PRODUCTOS\n// Obtener los datos de entrada\nconst productosInfo = $input.first().json.productos_info;\n\n// Crear lista actual de productos\nfunction crearListaActual() {\n  return productosInfo.map(p => `ðŸ§´ ${p.nombre} â†’ ${p.cantidad} uni`).join('\\n');\n}\n\n// Crear botones dinÃ¡micos basados en los productos actuales\nfunction crearBotones() {\n  return productosInfo.map(producto => ({\n    id: `cambiar_producto_${producto.nombre.toLowerCase().replace(/\\s+/g, '_')}`,\n    label: `ðŸ§´ ${producto.nombre}`\n  }));\n}\n\nconst listaActual = crearListaActual();\nconst botones = crearBotones();\n\n// Mensaje simplificado - escapando saltos de lÃ­nea para JSON\nconst mensajeAyudaTipoProductos = `ðŸ›ï¸Pedido actual:\\n${listaActual}\\n\\nPara cambiar productos, elija uno:`;\n\n// Retornar el resultado\nreturn {\n  json: {\n    mensaje_ayuda: mensajeAyudaTipoProductos,\n    botones: botones,\n    tipo_ayuda: \"cambiar_tipo_productos\",\n    productos_actuales: productosInfo.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2880,
        -816
      ],
      "id": "f471e952-0458-4da8-b64d-34f11bdb000b",
      "name": "cambiar_producto"
    },
    {
      "parameters": {
        "jsCode": "// Script para generar mensaje dinÃ¡mico de ayuda - CAMBIAR CANTIDADES\n// Obtener los datos de entrada\nconst productosInfo = $input.first().json.productos_info;\n// Crear lista actual de productos\nfunction crearListaActual() {\n  return productosInfo.map(p => `ðŸ§´ ${p.nombre} â†’ ${p.cantidad} uni`).join('\\n');\n}\n// Crear ejemplo dinÃ¡mico basado en productos actuales\nfunction crearEjemploDinamico() {\n  // Si solo hay 1 producto\n  if (productosInfo.length === 1) {\n    const producto = productosInfo[0];\n    const nuevaCantidad = Math.max(1, producto.cantidad === 1 ? 5 : producto.cantidad + 3);\n    return `- \"*${producto.nombre}* cambiar a ${nuevaCantidad} unidades\"`;\n  }\n  \n  // Si hay 2 o mÃ¡s productos - mostrar ejemplo con mÃºltiples\n  else {\n    const producto1 = productosInfo[0];\n    const producto2 = productosInfo[1];\n    const nuevaCantidad1 = Math.max(1, producto1.cantidad - 2);\n    const nuevaCantidad2 = Math.max(1, producto2.cantidad + 3);\n    return `- \"*${producto1.nombre}* cambiar a ${nuevaCantidad1} unidades, ${producto2.nombre} cambiar a ${nuevaCantidad2} unidades\"`;\n  }\n}\nconst listaActual = crearListaActual();\nconst ejemploDinamico = crearEjemploDinamico();\n// Mensaje de ayuda dinÃ¡mico para cambiar cantidades\nconst mensajeAyudaCantidad = `ðŸ”¢Pedido actual:\n${listaActual}\nPara cambiar cantidades, escribe asÃ­:\nðŸ“ *EJEMPLO:*\n${ejemploDinamico}\nðŸ“‹ *FORMATO FÃCIL:*\n[Nombre del producto] + [nueva cantidad]\nÂ¿QuÃ© cantidad quieres cambiar?`;\n// Retornar el resultado\nreturn {\n  json: {\n    mensaje_ayuda: mensajeAyudaCantidad,\n    tipo_ayuda: \"cambiar_cantidad\",\n    productos_actuales: productosInfo.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2880,
        -1008
      ],
      "id": "a5576409-3b53-4491-9996-dc620d82b3c0",
      "name": "cambiar_cantidad"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.mensaje_ayuda }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.mensaje_ayuda.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2656,
        -1008
      ],
      "id": "96b08fe7-b4cd-4900-9003-992ccaa628c4",
      "name": "Send cambiar_cantidad"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        -624
      ],
      "id": "d7d4f470-920a-4586-a6c1-b934355d7bdd",
      "name": "Get Data modificar_todo",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Script para generar mensaje de advertencia - BORRAR TODO\n// Obtener los datos de entrada\nconst productosInfo = $input.first().json.productos_info;\n\n// Crear lista actual de productos\nfunction crearListaActual() {\n  return productosInfo.map(p => `ðŸ§´ *${p.nombre}* â†’ ${p.cantidad} uni`).join('\\n');\n}\n\n// Crear botones dinÃ¡micos\nfunction crearBotones() {\n  return [\n    {\n      id: \"confirmar_borrar\",\n      label: \"âœ… SÃ­, borrar todo\"\n    },\n    {\n      id: \"confirmar_cancelar\",\n      label: \"âŒ No, cancelar\"\n    }\n  ];\n}\n\nconst listaActual = crearListaActual();\nconst botones = crearBotones();\nconst totalProductos = productosInfo.length;\nconst cantidadTotal = productosInfo.reduce((total, p) => total + p.cantidad, 0);\n\n// Mensaje de advertencia - escapando saltos de lÃ­nea para JSON\nconst mensajeAdvertencia = `âš ï¸ ADVERTENCIA\\n\\nEstÃ¡s a punto de borrar TODOS los productos seleccionados:\\n\\n${listaActual}\\n\\nðŸ“Š Total: ${totalProductos} productos (${cantidadTotal} unidades)\\n\\nÂ¿EstÃ¡s seguro de que quieres eliminar todo el pedido?`;\n\n// Retornar el resultado\nreturn {\n  json: {\n    mensaje_advertencia: mensajeAdvertencia,\n    botones: botones,\n    tipo_ayuda: \"confirmar_borrar_todo\",\n    productos_a_borrar: totalProductos,\n    cantidad_total: cantidadTotal\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2880,
        -624
      ],
      "id": "d029f2d7-2527-43a2-b651-f6096206e12b",
      "name": "modificar_todo"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        -432
      ],
      "id": "501eb520-80a9-4da3-a846-a7c0555bd576",
      "name": "Get Data agregar_productos",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Script para generar mensaje dinÃ¡mico de ayuda - AGREGAR PRODUCTOS\n// Obtener los datos de entrada\nconst productosInfo = $input.first().json.productos_info;\n\n// Crear lista actual de productos\nfunction crearListaActual() {\n  return productosInfo.map(p => `ðŸ§´ *${p.nombre}* â†’ ${p.cantidad} uni`).join('\\n');\n}\n\n// Productos alternativos para ejemplos (diferentes a los actuales)\nconst productosAlternativos = [\n  \"SAUVAGE\", \"HUGO BOSS MAN\", \"BLEU DE CHANEL\", \"DIOR HOMME\", \n  \"VERSACE DYLAN BLUE\", \"POLO BLUE\", \"ACQUA DI GIO\", \"INVICTUS\"\n];\n\n// Crear ejemplo dinÃ¡mico basado en productos actuales\nfunction crearEjemploDinamico() {\n  // Si solo hay 1 producto\n  if (productosInfo.length === 1) {\n    const productoNuevo = productosAlternativos[0]; // SAUVAGE\n    const cantidad = 5;\n    return `- \"Agregar *${productoNuevo}* ${cantidad} unidades\"`;\n  }\n  \n  // Si hay 2 o mÃ¡s productos - mostrar ejemplo con mÃºltiples productos nuevos\n  else {\n    const producto1 = productosAlternativos[0]; // SAUVAGE\n    const producto2 = productosAlternativos[1]; // HUGO BOSS MAN\n    const cantidad1 = 5;\n    const cantidad2 = 3;\n    \n    return `- \"Agregar *${producto1}* ${cantidad1} unidades, *${producto2}* ${cantidad2} unidades\"`;\n  }\n}\n\nconst listaActual = crearListaActual();\nconst ejemploDinamico = crearEjemploDinamico();\n\n// Mensaje de ayuda dinÃ¡mico para agregar productos\nconst mensajeAyudaAgregarProductos = `âž•Pedido actual:\n${listaActual}\n\nPara agregar mÃ¡s productos, escribe asÃ­:\n\nðŸ“ *EJEMPLO:*\n${ejemploDinamico}\n\nðŸ“‹ *FORMATO FÃCIL:*\n${productosInfo.length === 1 ? '\"Agregar [producto] [cantidad]\"' : '\"Agregar [producto] [cantidad], [producto] [cantidad]\"'}\n\nSe sumarÃ¡ a tu pedido actual\nÂ¿QuÃ© productos quieres agregar?`;\n\n// Retornar el resultado\nreturn {\n  json: {\n    mensaje_ayuda: mensajeAyudaAgregarProductos,\n    tipo_ayuda: \"agregar_productos\",\n    productos_actuales: productosInfo.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2880,
        -432
      ],
      "id": "3f7288c9-4b7d-4106-bf8a-4708f836af9c",
      "name": "agregar_productos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.mensaje_ayuda }}"
            },
            {
              "name": "delayTyping",
              "value": "={{ parseInt( $json.mensaje_ayuda.length() * 25) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2656,
        -432
      ],
      "id": "ee9968ea-4319-4c4c-8a53-54524711472b",
      "name": "Send agregar_productos"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_modificacion_producto_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'AGREGAR_PRODUCTOS');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2432,
        -432
      ],
      "id": "cfc804b2-5158-4cd2-8e8a-6a19ef853d8e",
      "name": "Get Data agregar_productos1",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_ventas_principal_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', NULL);\n\nSELECT actualizar_estado_modificacion_producto_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', NULL); \n\nSELECT delete_products_by_session('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');\n\nSELECT actualizar_estado_modificacion_producto_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', NULL);\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2880,
        144
      ],
      "id": "981f64d5-06b3-4639-913c-8eed164f6b7d",
      "name": "Get Data agregar_productos4",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_estado_modificacion_producto_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'EDIT_CANTIDAD');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2432,
        -1008
      ],
      "id": "b89e8c41-c552-45f2-93a7-1d36a1e8e14c",
      "name": "EDIT_CANTIDAD",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT delete_products_by_session('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');\nSELECT insert_n8n_update_product('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', '{{ $json.button_text }}');\nSELECT actualizar_estado_modificacion_producto_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'EDIT_PRODUCTO');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        -48
      ],
      "id": "a115d25b-3c92-4365-8e82-e626d64fdc1c",
      "name": "EDIT_PRODUCTO",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}\",\n  \"message\": {{ JSON.stringify($json.mensaje_ayuda) }},\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"buttons\": {{ JSON.stringify($json.botones) }}\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2656,
        -816
      ],
      "id": "d601c9f4-1362-45b6-9c03-a3b3ce824155",
      "name": "Send Buttons2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "cambiar_producto_",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "9949dc02-c7e4-4e28-b2b6-9d3cca9419e1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cambiar_producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3d7344e6-5a85-4b30-bc79-dd751be8a00c",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "confirmar_borrar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "confirmar_borrar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cf5141bc-460d-40e2-8481-6ed2c64f8aaf",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "eliminar_producto_",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "eliminar_producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1ff63386-8e23-41bf-bc70-a448423a6d67",
                    "leftValue": "={{ $json.button_id }}",
                    "rightValue": "subir_comprobante",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "subir_comprobante"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3328,
        272
      ],
      "id": "48bdb30d-78d5-48ab-9c7f-090eec05cfea",
      "name": "Edit Data"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('WhatsApp Message Parser').first().json.user.sender_phone }}\",\n  \"message\": {{ JSON.stringify($json.mensaje_advertencia) }},\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"buttons\": {{ JSON.stringify($json.botones) }}\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2656,
        -624
      ],
      "id": "160123d5-91fc-4860-957e-30d767f18ecc",
      "name": "Send Buttons3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            },
            {
              "name": "message",
              "value": "=Has seleccionado cambiar tu producto. Ahora, por favor escribe el nuevo producto y la cantidad que deseas, siguiendo este formato:\n\nðŸ“ Ejemplo:\n- \"SAUVAGE 5 unidades\""
            },
            {
              "name": "delayTyping",
              "value": "=5"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2880,
        -48
      ],
      "id": "a4612f67-9b50-4b94-a497-a1932b2e0317",
      "name": "Send Buttons  Edit Product"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('WhatsApp Message Parser').first().json.user.sender_phone }}\",\n  \"message\": \"Â¡No te vayas sin ver lo que tenemos para ti! ðŸ˜ƒ\\n\\nExplora nuestro catÃ¡logo, revisa las ofertas o haz un nuevo pedido.\",\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"buttons\": [\n      {\n        \"id\": \"comprar\",\n        \"label\": \"ðŸ›’ Comprar\"\n      },\n      {\n        \"id\": \"catalogo\",\n        \"label\": \"ðŸ“‹ CatÃ¡logo\"\n      },\n      {\n        \"id\": \"ofertas\",\n        \"label\": \"ðŸ”¥ Ofertas\"\n      },\n      {\n        \"id\": \"pedido\",\n        \"label\": \"ðŸ“¦ Consultar Pedido\"\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3104,
        144
      ],
      "id": "8f422ea0-31fc-4418-80f5-d907ff72b947",
      "name": "Send Buttons4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM obtener_estado_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        -240
      ],
      "id": "7ed138ac-2f98-4159-8126-49be19dfdd9a",
      "name": "Get Data Quitar Producto",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Script para generar mensaje dinÃ¡mico de ayuda - ELIMINAR PRODUCTO\nconst productosInfo = $input.first().json.productos_info;\n\nfunction crearListaActual() {\n  return productosInfo.map(p => `ðŸ§´ ${p.nombre} â†’ ${p.cantidad} uni`).join('\\n');\n}\n\nconst hayUnSoloProducto = productosInfo.length === 1;\n\nlet mensaje, botones, puedeModificar;\n\nif (hayUnSoloProducto) {\n  mensaje = `ðŸ›ï¸ Pedido actual:\\n${crearListaActual()}\\n\\nâš ï¸ Solo tienes un producto en el carrito.\\nÂ¿Deseas vaciar el carrito?`;\n  botones = [\n    {\n      id: \"confirmar_borrar\",\n      label: \"âœ… SÃ­, borrar todo\"\n    },\n    {\n      id: \"confirmar_cancelar\",\n      label: \"âŒ No, cancelar\"\n    }\n  ];\n  puedeModificar = false; // O true, segÃºn tu lÃ³gica\n} else {\n  mensaje = `ðŸ›ï¸ Pedido actual:\\n${crearListaActual()}\\n\\nSelecciona el producto a eliminar:`;\n  botones = productosInfo.map(producto => ({\n    id: `eliminar_producto_${producto.nombre.toLowerCase().replace(/\\s+/g, '_')}`,\n    label: `âŒ ${producto.nombre}`\n  }));\n  puedeModificar = true;\n}\n\nreturn {\n  json: {\n    mensaje_ayuda: mensaje,\n    botones: botones,\n    tipo_ayuda: \"eliminar_producto\",\n    productos_actuales: productosInfo.length,\n    un_solo_producto: hayUnSoloProducto,\n    puede_modificar: puedeModificar\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2880,
        -240
      ],
      "id": "f4af2d29-777c-4a32-a9b4-bd264610f900",
      "name": "quitar_producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}\",\n  \"message\": {{ JSON.stringify($json.mensaje_ayuda) }},\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"buttons\": {{ JSON.stringify($json.botones) }}\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2656,
        -240
      ],
      "id": "77c9e477-67fb-4e8d-ba0a-40f4b845fb0e",
      "name": "Send Buttons5"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT delete_products_by_session('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');\nSELECT insert_n8n_update_product('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', '{{ $json.button_text }}');\nSELECT actualizar_estado_modificacion_producto_pro('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}', 'MODIFICAR_TODO');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        336
      ],
      "id": "7d1aeff4-0f5f-4daa-9bf8-e9de10cb260a",
      "name": "EDIT_PRODUCTO1",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Entradas\nconst productDelete   = $('Get Update Product').first().json.product;          // nombre a eliminar\nconst productos_info  = $input.first().json.productos_info;                    // lista original\n\n// 2. Eliminar el producto indicado\nconst productosSinBorrar = productos_info.filter(\n  producto => producto.nombre !== productDelete\n);\n\n// 3. Cantidad total resultante\nconst cantidadTotal = productosSinBorrar.reduce(\n  (suma, p) => suma + (p.cantidad || 0),\n  0\n);\n\n// 4. FunciÃ³n precio unitario segÃºn cantidad total\nfunction precioPorEscala(qty) {\n  if (qty === 1)               return 60000;\n  if (qty === 2)               return 50000;\n  if (qty >= 3 && qty <= 5)    return 40000;\n  if (qty >= 6)                return 35000;\n  return 60000; // fallback\n}\n\n// 5. Precio unitario calculado\nconst precioUnitario = precioPorEscala(cantidadTotal);\n\n// 6. Calcular precio y total por producto\nconst productosFinales = productosSinBorrar.map(p => ({\n  ...p,\n  precio: precioUnitario,\n  total : precioUnitario * (p.cantidad || 0)\n}));\n\n// 7. Total general\nconst totalGeneral = productosFinales.reduce(\n  (suma, p) => suma + (p.total || 0),\n  0\n);\n\n// 8. Salida para n8n\nreturn [\n  {\n    json: {\n      productos_info : productosFinales,\n      cantidad_total : cantidadTotal,\n      precio_unitario: precioUnitario,\n      total_general  : totalGeneral,\n      producto_eliminado: productDelete\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2432,
        336
      ],
      "id": "d96ada9f-05ff-4ab0-b0c6-c65e8edd89ec",
      "name": "Code9"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_pro_conversation_states",
          "mode": "list",
          "cachedResultName": "n8n_pro_conversation_states"
        },
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            }
          ]
        },
        "options": {
          "outputColumns": [
            "productos_info"
          ]
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2656,
        336
      ],
      "id": "a7d0465b-f677-4c50-94de-61813cc36f3e",
      "name": "Get productos_info1",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_update_product",
          "mode": "list",
          "cachedResultName": "n8n_update_product"
        },
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
            }
          ]
        },
        "options": {
          "outputColumns": [
            "product"
          ]
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2880,
        336
      ],
      "id": "9253491d-3106-4e31-af94-c94ad25ae55b",
      "name": "Get Update Product",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT actualizar_productos_info_pro(\n  '{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}',\n  '{{ JSON.stringify($json.productos_info) }}'\n);\n\nSELECT delete_products_by_session('{{ $('WhatsApp Message Parser').item.json.user.sender_phone }}');\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2208,
        336
      ],
      "id": "324d3190-8e17-46b7-a5b6-a4ad76799c32",
      "name": "Execute a SQL query2",
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "LkGViUYxUOxTYhcA",
          "mode": "list",
          "cachedResultName": "My Sub Update Order"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "sessionId_firstItem": "={{ $('WhatsApp Message Parser').item.json.user.sender_phone }}"
          },
          "matchingColumns": [
            "sessionId_firstItem"
          ],
          "schema": [
            {
              "id": "sessionId_firstItem",
              "displayName": "sessionId_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -1984,
        336
      ],
      "id": "b0096f60-87e3-4d0d-a3ba-8338c0e2e5f7",
      "name": "Execute Workflow"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3E437048CF3D40E574FE2EE02AE98ECC/token/25512E9D7889005341E093C0/send-button-list",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F71f72d577fd94b2995487e18acdaa9ceS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"573011284297\",\n  \"message\": \"Has seleccionado pago por transferencia bancaria a travÃ©s de *BRE-B*.\\n\\nEn la imagen adjunta estÃ¡n los datos necesarios para realizar la transferencia.\\n\\nCuando completes el pago, por favor sube el comprobante usando el botÃ³n de abajo.\",\n  \"delayTyping\": 1500,\n  \"buttonList\": {\n    \"image\": \"https://drive.google.com/uc?export=download&id=14lwP1bnroMzeHQFusURZDdoedqo9ttmR\",\n    \"buttons\": [\n      {\n        \"id\": \"subir_comprobante\",\n        \"label\": \"ðŸ“„ Subir comprobante\"\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3104,
        -1392
      ],
      "id": "17be3662-317a-434f-9419-20e05456295e",
      "name": "Send Enviar Datos"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_pro_conversation_states",
          "mode": "list",
          "cachedResultName": "n8n_pro_conversation_states"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "conversacion_activa": false,
            "session_id": "={{ $('Message Type Router').item.json.user.sender_phone }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "fecha_inicio",
              "displayName": "fecha_inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultima_actividad",
              "displayName": "ultima_actividad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversacion_activa",
              "displayName": "conversacion_activa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "estado_actual",
              "displayName": "estado_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "estado_ventas",
              "displayName": "estado_ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre_cliente",
              "displayName": "nombre_cliente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ciudad",
              "displayName": "ciudad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "direccion",
              "displayName": "direccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pago",
              "displayName": "pago",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "total_producto",
              "displayName": "total_producto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "total_envio",
              "displayName": "total_envio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "cantidad_total",
              "displayName": "cantidad_total",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "guia",
              "displayName": "guia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "productos_info",
              "displayName": "productos_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "estado_modificacion_producto",
              "displayName": "estado_modificacion_producto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3104,
        528
      ],
      "id": "c57696e9-9c03-4850-9421-745c04f37735",
      "name": "Desactive Chat",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "8JM5p3eqNiJuC8uB",
          "name": "Postgres account"
        }
      }
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n.srv895922.hstgr.cloud",
            "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36",
            "content-length": "869",
            "content-type": "application/json",
            "origin": "https://api.z-api.io",
            "server": "Z-API",
            "x-forwarded-for": "164.152.40.9",
            "x-forwarded-host": "n8n.srv895922.hstgr.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "dce7a218380c",
            "x-real-ip": "164.152.40.9",
            "z-api-token": "25512E9D7889005341E093C0",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "isStatusReply": false,
            "chatLid": "33501416050920@lid",
            "connectedPhone": "573194651229",
            "waitingMessage": false,
            "isEdit": false,
            "isGroup": false,
            "isNewsletter": false,
            "instanceId": "3E437048CF3D40E574FE2EE02AE98ECC",
            "messageId": "3EB01224C4215BA478F011",
            "phone": "573011284297",
            "fromMe": false,
            "momment": 1753412027000,
            "status": "RECEIVED",
            "chatName": "Sergio R.",
            "senderPhoto": null,
            "senderName": "Sergio R.",
            "photo": "https://pps.whatsapp.net/v/t61.24694-24/518949464_1473845160724464_1356829479899435347_n.jpg?ccb=11-4&oh=01_Q5Aa2AF9YxiXzfLhcWdAstrGeDIAqq1qmMjbIwQw0SyN_SgJ4g&oe=689012CE&_nc_sid=5e03e0&_nc_cat=108",
            "broadcast": false,
            "participantLid": null,
            "referenceMessageId": "3EB052111DC1877D51E7BB",
            "messageExpirationSeconds": 0,
            "forwarded": false,
            "type": "ReceivedCallback",
            "fromApi": false,
            "buttonsResponseMessage": {
              "buttonId": "confirmar_pedido",
              "message": "ðŸŽ‰ Confirmar Pedido"
            }
          },
          "webhookUrl": "https://n8n.srv895922.hstgr.cloud/webhook/50a91089-2c34-4dd0-8896-2715bd6e9612",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "WhatsApp Message Parser": {
      "main": [
        [
          {
            "node": "Message Type Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "WhatsApp Message Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Router": {
      "main": [
        [
          {
            "node": "Download Audio File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pausa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Image File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Button Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio File": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image File": {
      "main": [
        [
          {
            "node": "Analyze Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pausa": {
      "main": [
        [
          {
            "node": "Obtener Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Extract Message Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Image": {
      "main": [
        [
          {
            "node": "Extract Message Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Button Response": {
      "main": [
        [
          {
            "node": "Button Response Router",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Product",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Button Response Router": {
      "main": [
        [
          {
            "node": "Dynamic Time Greeting",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dynamic Offers",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dynamic Buy",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dynamic Order",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Contra_Entrega",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Get Data User1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Enviar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Texto": {
      "main": [
        [
          {
            "node": "Extract Message Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message Content": {
      "main": [
        [
          {
            "node": "Store Message in Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Message in Buffer": {
      "main": [
        [
          {
            "node": "Wait for Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Buffer": {
      "main": [
        [
          {
            "node": "Retrieve Messages from Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retrieve Messages from Buffer": {
      "main": [
        [
          {
            "node": "Check for Duplicate Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Duplicate Message": {
      "main": [
        [
          {
            "node": "Clear Buffer Cache",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip Duplicate Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Buffer Cache": {
      "main": [
        [
          {
            "node": "Format Final Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Final Output": {
      "main": [
        [
          {
            "node": "Get session_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get session_id": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Dynamic Greeting",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Data User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Greeting": {
      "main": [
        [
          {
            "node": "Send Dynamic Greeting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Time Greeting": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Download Good Morning",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Good Afternoon",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download  Good Night",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Greeting": {
      "main": [
        [
          {
            "node": "Send Buttons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Audio": {
      "main": [
        [
          {
            "node": "Send Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Audio": {
      "main": [
        [
          {
            "node": "Send Catalog Man",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Catalog Man": {
      "main": [
        [
          {
            "node": "Send Catalog Women",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Good Morning": {
      "main": [
        [
          {
            "node": "Merge Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Good Afternoon": {
      "main": [
        [
          {
            "node": "Merge Audio",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Download  Good Night": {
      "main": [
        [
          {
            "node": "Merge Audio",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Dynamic Offers": {
      "main": [
        [
          {
            "node": "Send Dynamic Offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Buy": {
      "main": [
        [
          {
            "node": "Send Dynamic Buy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Order": {
      "main": [
        [
          {
            "node": "Send Dynamic Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Buttons": {
      "main": [
        [
          {
            "node": "Execute Status Greeting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Catalog Women": {
      "main": [
        [
          {
            "node": "Execute Status Catalog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Offers": {
      "main": [
        [
          {
            "node": "Execute Status Offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Buy": {
      "main": [
        [
          {
            "node": "Execute Status Buy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dynamic Order": {
      "main": [
        [
          {
            "node": "Execute Status Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Response IA": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Text Classifier",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Text Classifier": {
      "main": [
        [
          {
            "node": "COMPRA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "INVENTARIO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "RECOMENDACION",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "COMPARACION",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "COMPRA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Text Classifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "VALIDATOR DATA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "VALIDATOR DATA",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "COMPRA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data User": {
      "main": [
        [
          {
            "node": "Status Response IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data User1": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Send Buttons1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Product": {
      "main": [
        [
          {
            "node": "Get Data cambiar_cantidad",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Data cambiar_producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Data modificar_todo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Data agregar_productos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Data Quitar Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data cambiar_cantidad": {
      "main": [
        [
          {
            "node": "cambiar_cantidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data cambiar_producto": {
      "main": [
        [
          {
            "node": "cambiar_producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cambiar_producto": {
      "main": [
        [
          {
            "node": "Send Buttons2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cambiar_cantidad": {
      "main": [
        [
          {
            "node": "Send cambiar_cantidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data modificar_todo": {
      "main": [
        [
          {
            "node": "modificar_todo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "modificar_todo": {
      "main": [
        [
          {
            "node": "Send Buttons3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data agregar_productos": {
      "main": [
        [
          {
            "node": "agregar_productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agregar_productos": {
      "main": [
        [
          {
            "node": "Send agregar_productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send agregar_productos": {
      "main": [
        [
          {
            "node": "Get Data agregar_productos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send cambiar_cantidad": {
      "main": [
        [
          {
            "node": "EDIT_CANTIDAD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Data": {
      "main": [
        [
          {
            "node": "EDIT_PRODUCTO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Buttons4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "EDIT_PRODUCTO1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Desactive Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EDIT_PRODUCTO": {
      "main": [
        [
          {
            "node": "Send Buttons  Edit Product",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Buttons4": {
      "main": [
        [
          {
            "node": "Get Data agregar_productos4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data Quitar Producto": {
      "main": [
        [
          {
            "node": "quitar_producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "quitar_producto": {
      "main": [
        [
          {
            "node": "Send Buttons5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get productos_info1": {
      "main": [
        [
          {
            "node": "Code9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EDIT_PRODUCTO1": {
      "main": [
        [
          {
            "node": "Get Update Product",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Update Product": {
      "main": [
        [
          {
            "node": "Get productos_info1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code9": {
      "main": [
        [
          {
            "node": "Execute a SQL query2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query2": {
      "main": [
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "47edd482-4c4b-4e37-a881-2ab54cf71158",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9b741fad69cc6219b90142a4f3a46a45de0510680dd2fdf57a5402cd3a1e0176"
  },
  "id": "NARCxPg3jEuCsBaJ",
  "tags": [
    {
      "createdAt": "2025-07-24T01:28:48.246Z",
      "updatedAt": "2025-07-24T01:28:48.246Z",
      "id": "bI2UmbvTrUiQIVOH",
      "name": "VENTAS"
    }
  ]
}